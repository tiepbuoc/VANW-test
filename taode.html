<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tạo Đề Thi Văn Học - VANW</title>
    <link rel="icon" href="assets/logo.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.snow.css">
    <style>
        @import url('https://unpkg.com/normalize.css') layer(normalize);

        @layer normalize, base, demo;

        @layer base {
            :root {
                --font-size-min: 16;
                --font-size-max: 20;
                --font-ratio-min: 1.2;
                --font-ratio-max: 1.33;
                --font-width-min: 375;
                --font-width-max: 1500;
                
                --bg-color: #f5f5f5;
                --card-bg: #ffffff;
                --card-outline: #b0b0b0;
                --text-primary: #000000;
                --text-secondary: #666666;
                --border-color: #c0c0c0;
                --button-bg: rgba(0, 0, 0, 0.08);
                --grid-color: #a0a0a0;
                --gradient: linear-gradient(135deg, #e37c2d, #f5a742, #f8c34d, #fad859);
                --primary-color: #e37c2d;
                --accent-color: #fad859;
                --shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
                --scrollbar-track: #f0f0f0;
                --scrollbar-thumb: #c0c0c0;
                --scrollbar-thumb-hover: #a0a0a0;
                --verification-color: #4CAF50;
                --verification-bg: rgba(76, 175, 80, 0.1);
            }

            html {
                color-scheme: light;
            }

            *,
            *:after,
            *:before {
                box-sizing: border-box;
            }

            ::-webkit-scrollbar {
                width: 10px;
                height: 10px;
            }

            ::-webkit-scrollbar-track {
                background: var(--scrollbar-track);
                border-radius: 5px;
                border: 1px solid var(--card-outline);
            }

            ::-webkit-scrollbar-thumb {
                background: var(--scrollbar-thumb);
                border-radius: 5px;
                border: 1px solid var(--card-outline);
            }

            ::-webkit-scrollbar-thumb:hover {
                background: var(--scrollbar-thumb-hover);
            }

            * {
                scrollbar-width: thin;
                scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track);
            }

            body {
                background: var(--bg-color);
                display: grid;
                place-items: center;
                min-height: 100vh;
                font-family: 'SF Pro Text', 'SF Pro Icons', 'AOS Icons', 'Helvetica Neue',
                    Helvetica, Arial, sans-serif, system-ui;
                line-height: 1.5;
                color: var(--text-primary);
                padding: 2rem;
                margin: 0;
            }

            body::before {
                --size: 45px;
                --line: var(--grid-color);
                content: '';
                height: 100vh;
                width: 100vw;
                position: fixed;
                background: linear-gradient(
                        90deg,
                        var(--line) 1px,
                        transparent 1px var(--size)
                    )
                    calc(var(--size) * 0.36) 50% / var(--size) var(--size),
                    linear-gradient(var(--line) 1px, transparent 1px var(--size)) 0%
                        calc(var(--size) * 0.32) / var(--size) var(--size);
                mask: linear-gradient(-20deg, transparent 50%, white);
                top: 0;
                transform-style: flat;
                pointer-events: none;
                z-index: -1;
                opacity: 0.8;
            }

            .web-icon {
                position: fixed;
                top: 1rem;
                left: 1rem;
                width: 48px;
                aspect-ratio: 1;
                display: grid;
                place-items: center;
                opacity: 0.8;
                transition: opacity 0.2s;
            }

            .web-icon:hover {
                opacity: 1;
                transform: scale(1.05);
            }

            .web-icon img {
                width: 100%;
                height: 100%;
                object-fit: contain;
            }

            .sr-only {
                position: absolute;
                width: 1px;
                height: 1px;
                padding: 0;
                margin: -1px;
                overflow: hidden;
                clip: rect(0, 0, 0, 0);
                white-space: nowrap;
                border-width: 0;
            }
            
            .mr-2 {
                margin-right: 0.5rem;
            }
            
            .text-red-500 {
                color: #ef4444;
            }
            
            .w-full {
                width: 100%;
            }
            
            .border {
                border: 1px solid var(--card-outline);
            }
            
            .rounded-lg {
                border-radius: 8px;
            }
            
            .p-2 {
                padding: 0.5rem;
            }
            
            .mt-1 {
                margin-top: 0.25rem;
            }
            
            .mt-3 {
                margin-top: 0.75rem;
            }
            
            .mb-2 {
                margin-bottom: 0.5rem;
            }
            
            .mb-3 {
                margin-bottom: 0.75rem;
            }
            
            .text-green-600 {
                color: var(--verification-color);
            }
            
            .font-semibold {
                font-weight: 600;
            }
            
            .text-center {
                text-align: center;
            }
            
            .flex {
                display: flex;
            }
            
            .flex-wrap {
                flex-wrap: wrap;
            }
            
            .items-center {
                align-items: center;
            }
            
            .justify-between {
                justify-content: space-between;
            }
            
            .gap-2 {
                gap: 0.5rem;
            }
            
            .gap-3 {
                gap: 0.75rem;
            }
            
            .flex-1 {
                flex: 1;
            }
        }

        @layer demo {
            body {
                align-content: center;
                gap: 2rem;
                margin: 0;
                padding: 2rem;
                min-height: 100vh;
                display: grid;
                place-items: center;
            }

            .app-container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 2rem;
                width: 100%;
                padding-top: 40px;
            }
            
            main {
                touch-action: none;
                padding-block: 2rem;
                width: 100%;
                display: flex;
                flex-direction: column;
                gap: 2rem;
                align-items: center;
            }
            
            .exam-tool {
                padding: 0 0;
                background-color: transparent;
                width: 100%;
            }
            
            .exam-card {
                background: var(--card-bg);
                border-radius: 20px;
                padding: 2.5rem;
                box-shadow: var(--shadow);
                transition: all 0.4s ease;
                margin-bottom: 2rem;
                width: 100%;
                max-width: 900px;
                margin: 0 auto;
                border: 2px solid var(--card-outline);
            }
            
            .header-image {
                text-align: center;
                margin-bottom: 1.5rem;
            }
            
            .header-image img {
                max-width: 65%;
                height: auto;
            }
            
            .creation-mode-selector {
                margin-bottom: 2rem;
                background: rgba(227, 124, 45, 0.05);
                border-radius: 15px;
                padding: 1.5rem;
                border: 2px solid rgba(227, 124, 45, 0.2);
            }
            
            .creation-mode-selector h3 {
                color: var(--primary-color);
                margin: 0 0 1rem 0;
                font-size: 1.2rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            
            .mode-tabs {
                display: flex;
                gap: 1rem;
                margin-bottom: 1.5rem;
                flex-wrap: nowrap;
                overflow-x: auto;
                padding-bottom: 10px;
            }
            
            .mode-tab {
                flex: 1;
                min-width: 0;
                padding: 1rem;
                background: var(--card-bg);
                border: 2px solid var(--card-outline);
                border-radius: 12px;
                text-align: center;
                cursor: pointer;
                transition: all 0.3s ease;
                font-weight: 600;
                color: var(--text-secondary);
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 0.5rem;
                white-space: nowrap;
            }
            
            .mode-tab:hover {
                border-color: var(--primary-color);
                background: rgba(227, 124, 45, 0.05);
                transform: translateY(-3px);
            }
            
            .mode-tab.active {
                background: linear-gradient(135deg, rgba(227, 124, 45, 0.1), rgba(250, 216, 89, 0.1));
                border-color: var(--primary-color);
                color: var(--primary-color);
                box-shadow: 0 4px 15px rgba(227, 124, 45, 0.15);
            }
            
            .mode-tab i {
                font-size: 1.5rem;
            }
            
            .mode-content {
                display: none;
                animation: fadeIn 0.3s ease;
            }
            
            .mode-content.active {
                display: block;
            }
            
            .mode-description {
                color: var(--text-secondary);
                font-size: 0.95rem;
                margin-bottom: 1rem;
                padding: 0.5rem;
                background: rgba(255, 255, 255, 0.5);
                border-radius: 8px;
                border-left: 3px solid var(--primary-color);
            }
            
            .ai-prompt-area {
                margin-bottom: 1.5rem;
            }
            
            .ai-prompt-area textarea {
                width: 100%;
                min-height: 120px;
                padding: 1rem;
                border-radius: 12px;
                border: 2px solid var(--card-outline);
                background-color: var(--card-bg);
                color: var(--text-primary);
                font-size: 1rem;
                resize: vertical;
                transition: all 0.3s ease;
                font-family: inherit;
                line-height: 1.6;
            }
            
            .ai-prompt-area textarea:focus {
                outline: none;
                border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(227, 124, 45, 0.2);
            }
            
            .ai-prompt-examples {
                margin-top: 0.5rem;
                font-size: 0.9rem;
                color: var(--text-secondary);
            }
            
            .ai-prompt-examples ul {
                margin: 0.5rem 0 0 1.5rem;
                padding: 0;
            }
            
            .ai-prompt-examples li {
                margin-bottom: 0.25rem;
            }
            
            .blocky-controls {
                display: flex;
                gap: 1rem;
                margin-bottom: 1.5rem;
                flex-wrap: nowrap;
                overflow-x: auto;
                padding-bottom: 10px;
            }
            
            .blocky-btn {
                padding: 0.75rem 1.5rem;
                background: var(--card-bg);
                border: 2px solid var(--card-outline);
                border-radius: 30px;
                color: var(--text-primary);
                font-size: 0.95rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                white-space: nowrap;
                flex-shrink: 0;
            }
            
            .blocky-btn:hover {
                background: rgba(227, 124, 45, 0.1);
                border-color: var(--primary-color);
            }
            
            .blocky-preview {
                background: rgba(0, 0, 0, 0.02);
                border: 2px dashed var(--card-outline);
                border-radius: 12px;
                padding: 1.5rem;
                min-height: 200px;
                margin-bottom: 1.5rem;
            }
            
            .blocky-empty-state {
                text-align: center;
                color: var(--text-secondary);
                padding: 3rem 1rem;
            }
            
            .blocky-empty-state i {
                font-size: 3rem;
                margin-bottom: 1rem;
                opacity: 0.5;
            }
            
            .action-buttons {
                display: flex;
                gap: 1rem;
                margin-bottom: 2rem;
                flex-wrap: wrap;
            }
            
            .action-buttons.text-mode {
                justify-content: space-between;
            }
            
            .action-buttons.ai-mode,
            .action-buttons.blocky-mode {
                justify-content: flex-start;
            }
            
            .action-buttons .left-buttons {
                display: flex;
                gap: 1rem;
                flex: 1;
            }
            
            .action-buttons .right-buttons {
                display: flex;
                gap: 1rem;
            }
            
            .generate-btn {
                background: var(--gradient);
                color: white;
                padding: 1rem 2rem;
                border: none;
                border-radius: 30px;
                font-size: 1.1rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                position: relative;
                overflow: hidden;
                z-index: 1;
                display: flex;
                align-items: center;
                justify-content: center;
                white-space: nowrap;
            }
            
            .generate-btn::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 0%;
                height: 100%;
                background: rgba(255, 255, 255, 0.2);
                transition: all 0.5s;
                z-index: -1;
            }
            
            .generate-btn:hover::before {
                width: 100%;
            }
            
            .generate-btn:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
                border-color: var(--accent-color);
            }
            
            .generate-btn:disabled {
                background: #ccc;
                cursor: not-allowed;
                transform: none;
                box-shadow: none;
                border-color: #999;
                opacity: 0.7;
            }
            
            .generate-btn:disabled:hover::before {
                width: 0%;
            }
            
            .random-btn {
                background: linear-gradient(135deg, #9C27B0, #7B1FA2);
                color: white;
                padding: 1rem 1.5rem;
                border: none;
                border-radius: 30px;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                position: relative;
                overflow: hidden;
                z-index: 1;
                white-space: nowrap;
            }
            
            .random-btn::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 0%;
                height: 100%;
                background: rgba(255, 255, 255, 0.2);
                transition: all 0.5s;
                z-index: -1;
            }
            
            .random-btn:hover::before {
                width: 100%;
            }
            
            .random-btn:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
                opacity: 0.95;
            }
            
            .random-btn:disabled {
                background: #ccc;
                cursor: not-allowed;
                transform: none;
                box-shadow: none;
                opacity: 0.7;
            }
            
            .settings-btn {
                background: var(--card-bg);
                color: var(--text-primary);
                padding: 1rem 1.5rem;
                border: 2px solid var(--card-outline);
                border-radius: 30px;
                font-size: 1rem;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                white-space: nowrap;
            }
            
            .settings-btn:hover {
                background: rgba(227, 124, 45, 0.1);
                border-color: var(--primary-color);
            }
            
            .input-area {
                margin-bottom: 2rem;
                position: relative;
            }
            
            textarea {
                width: 100%;
                min-height: 200px;
                padding: 1.5rem;
                border-radius: 12px;
                border: 2px solid var(--card-outline);
                background-color: var(--card-bg);
                color: var(--text-primary);
                font-size: 1rem;
                resize: vertical;
                transition: all 0.3s ease;
                font-family: inherit;
                line-height: 1.6;
                white-space: pre-wrap;
            }
            
            textarea:focus {
                outline: none;
                border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(227, 124, 45, 0.2);
            }
            
            .word-count {
                position: absolute;
                bottom: 10px;
                right: 15px;
                font-size: 0.85rem;
                color: var(--text-secondary);
                background: rgba(255, 255, 255, 0.9);
                padding: 2px 8px;
                border-radius: 10px;
                border: 1px solid var(--card-outline);
            }
            
            .settings-panel {
                background: var(--card-bg);
                border-radius: 15px;
                padding: 1.5rem;
                margin-bottom: 2rem;
                display: none;
            }
            
            .settings-panel.active {
                display: block;
                animation: fadeIn 0.3s ease;
            }
            
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }
            
            .options-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 1.5rem;
            }
            
            .option-card {
                background: var(--card-bg);
                border-radius: 12px;
                padding: 1.5rem;
                box-shadow: var(--shadow);
                transition: all 0.3s ease;
                border-left: 5px solid var(--primary-color);
                border: 2px solid var(--card-outline);
            }
            
            .option-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
                border-color: var(--primary-color);
            }
            
            .option-card h3 {
                color: var(--primary-color);
                margin-bottom: 1rem;
                font-size: 1.2rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            
            .option-card h3 i {
                font-size: 1.1rem;
            }
            
            .duration-control {
                margin-top: 15px;
            }
            
            .duration-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .duration-control label {
                font-weight: 600;
                color: var(--text-primary);
                font-size: 1rem;
            }
            
            #examTimeValue {
                font-weight: bold;
                color: var(--primary-color);
                font-size: 1.1rem;
                margin-left: 5px;
            }
            
            .duration-buttons {
                display: flex;
                gap: 8px;
            }
            
            .duration-btn {
                padding: 6px 12px;
                background: var(--card-bg);
                border: 2px solid var(--card-outline);
                border-radius: 20px;
                color: var(--text-primary);
                font-size: 0.9rem;
                cursor: pointer;
                transition: all 0.3s ease;
                font-weight: 500;
            }
            
            .duration-btn:hover {
                background: rgba(227, 124, 45, 0.1);
                border-color: var(--primary-color);
            }
            
            .duration-btn.active {
                background: var(--primary-color);
                color: white;
                border-color: var(--primary-color);
            }
            
            #examTimeSlider {
                width: 100%;
                height: 10px;
                -webkit-appearance: none;
                appearance: none;
                background: linear-gradient(to right, var(--primary-color) 0%, var(--primary-color) 50%, var(--border-color) 50%, var(--border-color) 100%);
                border-radius: 5px;
                outline: none;
                margin-top: 10px;
            }
            
            #examTimeSlider::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 26px;
                height: 26px;
                border-radius: 50%;
                background: var(--primary-color);
                cursor: pointer;
                border: 3px solid white;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                transition: all 0.2s ease;
            }
            
            #examTimeSlider::-webkit-slider-thumb:hover {
                transform: scale(1.1);
                background: var(--accent-color);
                box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            }
            
            .toggle-container {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 1rem;
                padding: 8px 0;
                border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            }
            
            .toggle-container:last-child {
                border-bottom: none;
                margin-bottom: 0;
            }
            
            .toggle-label {
                font-weight: 500;
                color: var(--text-primary);
                font-size: 0.95rem;
                flex: 1;
            }
            
            .toggle-switch {
                position: relative;
                display: inline-block;
                width: 50px;
                height: 26px;
                flex-shrink: 0;
            }
            
            .toggle-switch input {
                opacity: 0;
                width: 0;
                height: 0;
            }
            
            .toggle-slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: #ccc;
                transition: .4s;
                border-radius: 34px;
                border: 2px solid #aaa;
            }
            
            .toggle-slider:before {
                position: absolute;
                content: "";
                height: 18px;
                width: 18px;
                left: 2px;
                bottom: 2px;
                background-color: white;
                transition: .4s;
                border-radius: 50%;
                border: 1px solid #ddd;
            }
            
            input:checked + .toggle-slider {
                background-color: var(--primary-color);
                border-color: var(--primary-color);
            }
            
            input:checked + .toggle-slider:before {
                transform: translateX(24px);
            }
            
            .select-container {
                margin-bottom: 1rem;
            }
            
            .block-label {
                display: block;
                font-size: 0.9rem;
                color: var(--text-secondary);
                margin-bottom: 0.5rem;
                font-weight: 500;
            }
            
            select {
                width: 100%;
                padding: 0.85rem;
                border-radius: 10px;
                border: 2px solid var(--card-outline);
                background-color: var(--card-bg);
                color: var(--text-primary);
                font-size: 1rem;
                transition: all 0.3s ease;
                font-family: inherit;
                cursor: pointer;
            }
            
            select:focus {
                outline: none;
                border-color: var(--primary-color);
                box-shadow: 0 0 0 3px rgba(227, 124, 45, 0.2);
            }
            
            .progress-container {
                margin-top: 2rem;
                background-color: var(--card-bg);
                border-radius: 15px;
                padding: 1.8rem;
                box-shadow: var(--shadow);
                border: 2px solid var(--card-outline);
            }
            
            .progress-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1.2rem;
            }
            
            .progress-title {
                font-weight: 700;
                color: var(--primary-color);
                font-size: 1.3rem;
            }
            
            .progress-status {
                font-size: 1rem;
                color: var(--text-primary);
                font-weight: 500;
            }
            
            .progress-bar {
                height: 12px;
                background-color: #e0e0e0;
                border-radius: 6px;
                overflow: hidden;
                margin-bottom: 1.2rem;
                border: 2px solid #ccc;
            }
            
            .progress-fill {
                height: 100%;
                background: var(--gradient);
                border-radius: 6px;
                transition: width 0.4s ease;
            }
            
            .progress-items {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
                gap: 0.8rem;
                max-height: 220px;
                overflow-y: auto;
                padding-right: 10px;
            }
            
            .progress-item {
                display: flex;
                align-items: center;
                font-size: 1rem;
                color: var(--text-primary);
                padding: 8px 12px;
                border-radius: 8px;
                border: 2px solid transparent;
                background: rgba(0, 0, 0, 0.02);
                transition: all 0.3s ease;
            }
            
            .progress-item:hover {
                border-color: var(--card-outline);
                background: rgba(227, 124, 45, 0.05);
            }
            
            .progress-item i {
                margin-right: 10px;
                font-size: 1rem;
            }
            
            .progress-item.completed {
                color: var(--primary-color);
                border-color: rgba(227, 124, 45, 0.4);
                background-color: rgba(227, 124, 45, 0.08);
            }
            
            .progress-item.pending {
                color: #9ca3af;
                border-color: rgba(156, 163, 175, 0.3);
            }
            
            .progress-item.error {
                color: #ef4444;
                border-color: rgba(239, 68, 68, 0.4);
                background-color: rgba(239, 68, 68, 0.08);
            }
            
            .progress-item.verification {
                color: var(--verification-color);
                border-color: rgba(76, 175, 80, 0.4);
                background-color: var(--verification-bg);
                font-weight: 600;
                animation: pulse 2s infinite;
            }
            
            @keyframes pulse {
                0% {
                    box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4);
                }
                70% {
                    box-shadow: 0 0 0 10px rgba(76, 175, 80, 0);
                }
                100% {
                    box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
                }
            }
            
            .exam-result-container {
                margin-top: 2rem;
                background: var(--card-bg);
                border-radius: 15px;
                padding: 2rem;
                box-shadow: var(--shadow);
                border: 2px solid var(--card-outline);
            }
            
            .exam-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1.5rem;
                padding-bottom: 1rem;
                border-bottom: 2px solid var(--card-outline);
            }
            
            .exam-header h3 {
                color: var(--primary-color);
                font-size: 1.3rem;
                margin: 0;
            }
            
            .exam-code {
                background: rgba(227, 124, 45, 0.1);
                padding: 0.5rem 1rem;
                border-radius: 20px;
                font-weight: 600;
                color: var(--primary-color);
                border: 2px solid var(--primary-color);
            }
            
            .exam-info {
                background: rgba(227, 124, 45, 0.05);
                padding: 1rem;
                border-radius: 8px;
                margin-bottom: 1.5rem;
                border: 1px solid var(--card-outline);
            }
            
            .preview-exam {
                font-family: inherit;
            }
            
            .preview-exam .exam-title {
                text-align: center;
                color: var(--primary-color);
                font-size: 1.8rem;
                margin-bottom: 1rem;
                padding-bottom: 1rem;
                border-bottom: 3px solid var(--primary-color);
            }
            
            .preview-exam .exam-info {
                text-align: center;
                color: var(--text-secondary);
                margin-bottom: 2rem;
                font-size: 0.95rem;
            }
            
            .preview-exam .exam-section {
                margin-bottom: 2rem;
            }
            
            .preview-exam .section-title {
                color: var(--primary-color);
                font-size: 1.3rem;
                margin-bottom: 1rem;
                padding-bottom: 0.5rem;
                border-bottom: 2px solid rgba(227, 124, 45, 0.3);
            }
            
            .preview-exam .text-content {
                background: rgba(0, 0, 0, 0.02);
                padding: 1rem;
                border-radius: 8px;
                margin-bottom: 1.5rem;
                border-left: 4px solid var(--primary-color);
                line-height: 1.7;
                white-space: pre-wrap;
                font-family: 'Times New Roman', Times, serif;
            }
            
            .preview-exam .question-item {
                background: var(--card-bg);
                border: 2px solid var(--card-outline);
                border-radius: 8px;
                padding: 1.5rem;
                margin-bottom: 1rem;
            }
            
            .preview-exam .question-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 1rem;
            }
            
            .preview-exam .question-text {
                flex: 1;
                font-weight: 500;
                color: var(--text-primary);
                font-size: 1.05rem;
            }
            
            .preview-exam .question-points {
                background: var(--primary-color);
                color: white;
                padding: 0.25rem 0.75rem;
                border-radius: 20px;
                font-size: 0.9rem;
                font-weight: 600;
                margin-left: 1rem;
                flex-shrink: 0;
            }
            
            .preview-exam .answer-area {
                margin-top: 1rem;
            }
            
            .preview-exam .answer-textarea {
                width: 100%;
                min-height: 80px;
                padding: 0.75rem;
                border: 1px dashed var(--card-outline);
                border-radius: 6px;
                background: rgba(0, 0, 0, 0.02);
                color: var(--text-primary);
                font-family: inherit;
                font-size: 0.95rem;
                white-space: pre-wrap;
            }
            
            .exam-actions {
                display: flex;
                gap: 1rem;
                justify-content: center;
                margin-top: 2rem;
                flex-wrap: wrap;
            }
            
            .exam-action-btn {
                padding: 12px 24px;
                border-radius: 8px;
                border: none;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                min-width: 150px;
                justify-content: center;
            }
            
            .preview-btn {
                background: linear-gradient(135deg, #9C27B0, #7B1FA2);
                color: white;
            }
            
            .edit-btn {
                background: linear-gradient(135deg, #FF9800, #F57C00);
                color: white;
            }
            
            .save-btn {
                background: linear-gradient(135deg, #4CAF50, #45a049);
                color: white;
            }
            
            .reset-btn {
                background: linear-gradient(135deg, #FF5722, #E64A19);
                color: white;
            }
            
            .add-btn {
                background: linear-gradient(135deg, #2196F3, #1976D2);
                color: white;
            }
            
            .exam-action-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                opacity: 0.95;
            }
            
            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1000;
                align-items: center;
                justify-content: center;
            }
            
            .modal.active {
                display: flex;
                animation: fadeIn 0.3s ease;
            }
            
            .modal-content {
                background: var(--card-bg);
                border-radius: 12px;
                width: 90%;
                max-width: 800px;
                max-height: 90vh;
                display: flex;
                flex-direction: column;
                border: 3px solid var(--primary-color);
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            }
            
            .modal-content.large-modal {
                max-width: 1000px;
                max-height: 95vh;
            }
            
            .modal-header {
                padding: 1.5rem;
                border-bottom: 2px solid var(--card-outline);
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .modal-header h3 {
                color: var(--primary-color);
                margin: 0;
                font-size: 1.3rem;
            }
            
            .close-modal {
                background: none;
                border: none;
                font-size: 1.5rem;
                color: var(--text-secondary);
                cursor: pointer;
                transition: color 0.2s;
            }
            
            .close-modal:hover {
                color: var(--primary-color);
            }
            
            .modal-body {
                padding: 1.5rem;
                overflow-y: auto;
                flex: 1;
            }
            
            .modal-footer {
                padding: 1.5rem;
                border-top: 2px solid var(--card-outline);
                display: flex;
                justify-content: flex-end;
                gap: 1rem;
            }
            
            .modal-btn {
                padding: 10px 20px;
                border-radius: 8px;
                border: none;
                font-size: 1rem;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
            }
            
            .modal-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            }
            
            .secondary-btn {
                background: var(--card-bg);
                border: 2px solid var(--card-outline);
                color: var(--text-primary);
            }
            
            .secondary-btn:hover {
                border-color: var(--primary-color);
                background: rgba(227, 124, 45, 0.1);
            }
            
            .exam-editor-container {
                max-width: 100%;
            }
            
            .editor-actions {
                display: flex;
                gap: 1rem;
                margin-bottom: 1.5rem;
                flex-wrap: wrap;
            }
            
            .editor-action-btn {
                padding: 10px 20px;
                background: var(--card-bg);
                border: 2px solid var(--card-outline);
                border-radius: 8px;
                color: var(--text-primary);
                font-size: 0.95rem;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .editor-action-btn:hover {
                background: rgba(227, 124, 45, 0.1);
                border-color: var(--primary-color);
            }
            
            .rich-text-editor {
                border: 2px solid var(--card-outline);
                border-radius: 8px;
                overflow: hidden;
                margin-bottom: 1rem;
            }
            
            .rich-text-editor .ql-toolbar {
                border-bottom: 2px solid var(--card-outline);
                background: rgba(227, 124, 45, 0.05);
            }
            
            .rich-text-editor .ql-container {
                font-family: inherit;
                font-size: 1rem;
                min-height: 200px;
                max-height: 300px;
                overflow-y: auto;
            }
            
            .rich-text-editor .ql-editor {
                min-height: 200px;
                white-space: pre-wrap;
            }
            
            .text-preview {
                font-family: inherit;
                line-height: 1.8;
                color: var(--text-primary);
            }
            
            .text-preview h3 {
                color: var(--primary-color);
                margin-bottom: 1rem;
                padding-bottom: 0.5rem;
                border-bottom: 2px solid var(--primary-color);
            }
            
            .text-preview .text-content {
                background: rgba(0, 0, 0, 0.02);
                padding: 1.5rem;
                border-radius: 8px;
                border-left: 4px solid var(--primary-color);
                max-height: 400px;
                overflow-y: auto;
                margin-bottom: 1rem;
                white-space: pre-line;
                line-height: 1.7;
                font-family: 'Times New Roman', Times, serif;
            }
            
            .text-preview .text-meta {
                display: flex;
                flex-wrap: wrap;
                gap: 1rem;
                margin-top: 1rem;
                padding: 1rem;
                background: rgba(227, 124, 45, 0.05);
                border-radius: 8px;
                font-size: 0.9rem;
                color: var(--text-secondary);
            }
            
            .text-preview .meta-item {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            
            .app-footer {
                text-align: center;
                margin-top: 3rem;
                padding-top: 2rem;
                border-top: 2px solid var(--border-color);
                color: var(--text-secondary);
            }
            
            .app-footer a {
                color: var(--primary-color);
                text-decoration: none;
                font-weight: 600;
                transition: all 0.3s ease;
            }
            
            .app-footer a:hover {
                text-decoration: underline;
                color: var(--accent-color);
            }
            
            .markdown-content {
                font-family: inherit;
                line-height: 1.6;
            }
            
            .markdown-content h1 {
                color: var(--primary-color);
                font-size: 1.8rem;
                margin: 1.5rem 0 1rem;
                padding-bottom: 0.5rem;
                border-bottom: 3px solid var(--primary-color);
            }
            
            .markdown-content h2 {
                color: var(--primary-color);
                font-size: 1.5rem;
                margin: 1.2rem 0 0.8rem;
                padding-left: 0.5rem;
                border-left: 3px solid var(--primary-color);
            }
            
            .markdown-content h3 {
                color: var(--accent-color);
                font-size: 1.3rem;
                margin: 1rem 0 0.6rem;
            }
            
            .markdown-content p {
                margin-bottom: 1rem;
            }
            
            .markdown-content strong {
                color: var(--primary-color);
                font-weight: 700;
            }
            
            .markdown-content em {
                color: var(--text-secondary);
                font-style: italic;
            }
            
            .markdown-content ul, .markdown-content ol {
                margin-left: 1.5rem;
                margin-bottom: 1rem;
            }
            
            .markdown-content li {
                margin-bottom: 0.5rem;
            }
            
            .markdown-content blockquote {
                border-left: 4px solid var(--accent-color);
                margin: 1rem 0;
                padding: 0.5rem 1rem;
                background: rgba(250, 216, 89, 0.1);
                font-style: italic;
            }
            
            .blocky-block {
                background: var(--card-bg);
                border: 2px solid var(--card-outline);
                border-radius: 8px;
                padding: 1rem;
                margin-bottom: 1rem;
                position: relative;
            }
            
            .blocky-block-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1rem;
                padding-bottom: 0.5rem;
                border-bottom: 1px solid var(--card-outline);
            }
            
            .blocky-block-title {
                font-weight: 600;
                color: var(--primary-color);
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            
            .blocky-block-controls {
                display: flex;
                gap: 0.5rem;
            }
            
            .blocky-block-btn {
                padding: 0.25rem 0.5rem;
                background: var(--card-bg);
                border: 1px solid var(--card-outline);
                border-radius: 4px;
                color: var(--text-primary);
                cursor: pointer;
                transition: all 0.3s ease;
            }
            
            .blocky-block-btn:hover {
                background: rgba(227, 124, 45, 0.1);
                border-color: var(--primary-color);
            }
            
            .blocky-block-content {
                min-height: 50px;
            }
            
            .blocky-rich-editor {
                border: 2px solid var(--card-outline);
                border-radius: 8px;
                overflow: hidden;
                margin-bottom: 1rem;
            }
            
            .blocky-rich-editor .ql-toolbar {
                border-bottom: 2px solid var(--card-outline);
                background: rgba(227, 124, 45, 0.05);
            }
            
            .blocky-rich-editor .ql-container {
                font-family: inherit;
                font-size: 1rem;
                min-height: 150px;
                max-height: 250px;
                overflow-y: auto;
            }
            
            .blocky-rich-editor .ql-editor {
                min-height: 150px;
                white-space: pre-wrap;
            }
            
            .blocky-block-content textarea {
                width: 100%;
                min-height: 100px;
                padding: 0.75rem;
                border: 1px solid var(--card-outline);
                border-radius: 6px;
                font-family: inherit;
                font-size: 1rem;
                resize: vertical;
                white-space: pre-wrap;
            }
            
            .blocky-block-content textarea:focus {
                outline: none;
                border-color: var(--primary-color);
            }
            
            .blocky-block-footer {
                display: flex;
                justify-content: flex-end;
                margin-top: 0.5rem;
            }
            
            @media (max-width: 992px) {
                .options-grid {
                    grid-template-columns: 1fr;
                }
                
                .mode-tabs {
                    flex-wrap: wrap;
                }
                
                .mode-tab {
                    min-width: calc(33.333% - 0.67rem);
                }
                
                .blocky-controls {
                    flex-wrap: wrap;
                }
                
                .blocky-btn {
                    min-width: calc(33.333% - 0.67rem);
                }
            }
            
            @media (max-width: 768px) {
                body {
                    padding: 1rem;
                }
                
                .exam-card {
                    padding: 1.8rem;
                }
                
                .action-buttons {
                    flex-direction: column;
                    gap: 1rem;
                }
                
                .action-buttons .left-buttons,
                .action-buttons .right-buttons {
                    width: 100%;
                    flex-direction: column;
                }
                
                .generate-btn, .random-btn, .settings-btn {
                    width: 100%;
                }
                
                .app-container {
                    padding: 1rem;
                    padding-top: 20px;
                }
                
                main {
                    gap: 1.5rem;
                    padding-block: 1rem;
                }
                
                .mode-tabs {
                    flex-direction: row;
                    flex-wrap: nowrap;
                    overflow-x: auto;
                }
                
                .mode-tab {
                    min-width: 150px;
                    flex-shrink: 0;
                }
                
                .blocky-controls {
                    flex-direction: row;
                    flex-wrap: nowrap;
                    overflow-x: auto;
                }
                
                .blocky-btn {
                    min-width: 150px;
                    flex-shrink: 0;
                }
                
                .duration-header {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 15px;
                }
                
                .duration-buttons {
                    width: 100%;
                    justify-content: space-between;
                }
                
                .duration-btn {
                    flex: 1;
                    text-align: center;
                }
                
                .exam-header {
                    flex-direction: column;
                    gap: 1rem;
                    text-align: center;
                }
                
                .exam-actions {
                    flex-direction: column;
                    align-items: stretch;
                }
                
                .exam-action-btn {
                    min-width: 100%;
                }
                
                .modal-content {
                    width: 95%;
                    margin: 0.5rem;
                }
                
                .modal-content.large-modal {
                    width: 98%;
                    max-height: 90vh;
                }
                
                .editor-actions {
                    flex-direction: column;
                }
                
                .editor-action-btn {
                    width: 100%;
                    justify-content: center;
                }
                
                .app-footer {
                    margin-top: 2rem;
                    padding-top: 1.5rem;
                }
                
                .app-footer p {
                    font-size: 0.9rem;
                }
            }
            
            @media (max-width: 480px) {
                body {
                    padding: 0.5rem;
                }
                
                .app-container {
                    padding: 0.5rem;
                    padding-top: 15px;
                }
                
                .mode-tab {
                    min-width: 120px;
                    padding: 0.75rem 0.5rem;
                    font-size: 0.9rem;
                }
                
                .mode-tab i {
                    font-size: 1.2rem;
                }
                
                .blocky-btn {
                    min-width: 120px;
                    padding: 0.6rem 1rem;
                    font-size: 0.9rem;
                }
                
                .progress-items {
                    grid-template-columns: 1fr;
                }
                
                .header-image img {
                    max-width: 100%;
                }
                
                .modal-content {
                    width: 95%;
                    margin: 0.5rem;
                }
                
                .action-buttons {
                    gap: 0.75rem;
                }
                
                .generate-btn, .random-btn, .settings-btn {
                    padding: 0.9rem 1.2rem;
                    font-size: 1rem;
                }
            }
            
            @media (min-width: 1200px) {
                .exam-card {
                    max-width: 1000px;
                }
                
                .mode-tab {
                    min-width: 200px;
                }
                
                .blocky-btn {
                    min-width: 180px;
                }
            }
        }
    </style>
</head>
<body>
    <a aria-label="Website Icon" class="web-icon" href="index.html" rel="noreferrer noopener">
        <img src="assets/logo.png" alt="Website Icon" />
    </a>
    
    <div class="app-container">
        <main>
            <div class="exam-tool">
                <div class="exam-card">
                    <div class="header-image">
                        <img src="assets/htext1.png" alt="HỆ THỐNG TẠO BÀI THI VĂN HỌC">
                    </div>
                    
                    <div class="creation-mode-selector">
                        <h3><i class="fas fa-sliders-h"></i> CHẾ ĐỘ TẠO ĐỀ THI</h3>
                        <div class="mode-tabs">
                            <div class="mode-tab active" data-mode="text">
                                <i class="fas fa-file-alt"></i>
                                <span>Tạo theo văn bản</span>
                            </div>
                            <div class="mode-tab" data-mode="ai">
                                <i class="fas fa-robot"></i>
                                <span>Tạo bằng AI</span>
                            </div>
                            <div class="mode-tab" data-mode="blocky">
                                <i class="fas fa-cubes"></i>
                                <span>Tạo Blocky</span>
                            </div>
                        </div>
                        
                        <div class="mode-content active" id="mode-text">
                            <div class="mode-description">
                                <strong>Mô tả:</strong> Nhập văn bản văn học có sẵn, hệ thống sẽ tự động tạo đề thi từ văn bản đó.
                            </div>
                            <div class="input-area" id="existingTextArea">
                                <textarea id="inputText" placeholder="Nhập hoặc dán nội dung văn bản văn học cần tạo đề thi... (Tối thiểu 20 từ)"></textarea>
                                <div class="word-count" id="wordCount">0 từ</div>
                            </div>
                        </div>
                        
                        <div class="mode-content" id="mode-ai">
                            <div class="mode-description">
                                <strong>Mô tả:</strong> Nhập yêu cầu bằng tiếng Việt, AI sẽ tự động tạo đề thi từ A-Z dựa trên yêu cầu của bạn.
                            </div>
                            <div class="ai-prompt-area">
                                <textarea id="aiPrompt" placeholder="Nhập yêu cầu tạo đề thi... (Ví dụ: Tạo đề thi về bài thơ 'Sóng' của Xuân Quỳnh cho lớp 12 với 5 câu hỏi...)"></textarea>
                                <div class="ai-prompt-examples">
                                    <strong>Ví dụ yêu cầu AI:</strong>
                                    <ul>
                                        <li>Tạo đề thi về truyện ngắn "Chí Phèo" của Nam Cao cho lớp 11</li>
                                        <li>Tạo đề thi thơ với bài "Đây thôn Vĩ Dạ" của Hàn Mặc Tử</li>
                                        <li>Tạo đề đọc hiểu về văn bản nghị luận xã hội</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mode-content" id="mode-blocky">
                            <div class="mode-description">
                                <strong>Mô tả:</strong> Tạo đề thi bằng cách thêm, xóa và chỉnh sửa từng khối câu hỏi và nội dung.
                            </div>
                            <div class="blocky-controls">
                                <button id="addTextBlockBtn" class="blocky-btn">
                                    <i class="fas fa-paragraph"></i> Thêm văn bản
                                </button>
                                <button id="addQuestionBlockBtn" class="blocky-btn">
                                    <i class="fas fa-question-circle"></i> Thêm câu hỏi
                                </button>
                                <button id="clearBlocksBtn" class="blocky-btn">
                                    <i class="fas fa-trash"></i> Xóa tất cả
                                </button>
                            </div>
                            <div class="blocky-preview" id="blockyPreview">
                                <div class="blocky-empty-state">
                                    <i class="fas fa-cubes"></i>
                                    <h4>Chưa có nội dung</h4>
                                    <p>Bấm vào nút "Thêm văn bản" hoặc "Thêm câu hỏi" để bắt đầu tạo đề thi</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="action-buttons text-mode" id="actionButtonsContainer">
                        <div class="left-buttons">
                            <button id="generateExamBtn" class="generate-btn">
                                <i class="fas fa-file-alt mr-2"></i> Tạo Đề Thi
                            </button>
                            <button id="generateRandomExamBtn" class="random-btn">
                                <i class="fas fa-dice mr-2"></i> Đề Thi Ngẫu Nhiên
                            </button>
                        </div>
                        <div class="right-buttons">
                            <button id="settingsBtn" class="settings-btn">
                                <i class="fas fa-cog mr-2"></i> Cài đặt
                            </button>
                        </div>
                    </div>
                    
                    <div class="settings-panel" id="settingsPanel">
                        <div class="options-grid">
                            <div class="option-card">
                                <h3><i class="fas fa-clock"></i> Thời gian làm bài</h3>
                                <div class="duration-control">
                                    <div class="duration-header">
                                        <label for="examTimeSlider">Thời gian: <span id="examTimeValue">90 phút</span></label>
                                        <div class="duration-buttons">
                                            <button type="button" class="duration-btn" data-value="45">45p</button>
                                            <button type="button" class="duration-btn" data-value="90">90p</button>
                                            <button type="button" class="duration-btn" data-value="120">120p</button>
                                        </div>
                                    </div>
                                    <input type="range" id="examTimeSlider" min="30" max="180" step="15" value="90">
                                </div>
                            </div>
                            
                            <div class="option-card">
                                <h3><i class="fas fa-sliders-h"></i> Cài đặt đề thi</h3>
                                <div class="select-container">
                                    <label class="block-label">Độ khó</label>
                                    <select id="difficulty">
                                        <option value="easy">Dễ</option>
                                        <option value="medium" selected>Trung bình</option>
                                        <option value="hard">Khó</option>
                                    </select>
                                </div>
                                <div class="select-container mt-3">
                                    <label class="block-label">Khối lớp</label>
                                    <select id="grade">
                                        <option value="10">Lớp 10</option>
                                        <option value="11">Lớp 11</option>
                                        <option value="12" selected>Lớp 12</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="option-card">
                                <h3><i class="fas fa-plus-circle"></i> Cấu trúc đề thi</h3>
                                <div class="toggle-container">
                                    <span class="toggle-label">Phần đọc hiểu</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="readingToggle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-container">
                                    <span class="toggle-label">Phần nghị luận văn học</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="essayToggle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-container">
                                    <span class="toggle-label">Phần liên hệ thực tế</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="practiceToggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="mt-3">
                                    <label class="block-label">Số câu hỏi</label>
                                    <input type="number" id="questionCount" min="3" max="10" value="5" class="w-full border border-gray-300 rounded-lg p-2 mt-1">
                                </div>
                            </div>
                            
                            <div class="option-card">
                                <h3><i class="fas fa-random"></i> Tạo đề thi ngẫu nhiên</h3>
                                <div class="select-container">
                                    <label class="block-label">Chọn tác giả</label>
                                    <select id="randomAuthor">
                                        <option value="random" selected>Tác giả ngẫu nhiên</option>
                                        <option value="xuan_dieu">Xuân Diệu</option>
                                        <option value="nam_cao">Nam Cao</option>
                                        <option value="thach_lam">Thạch Lam</option>
                                        <option value="to_hoai">Tô Hoài</option>
                                        <option value="nguyen_tuan">Nguyễn Tuân</option>
                                        <option value="nguyen_khuyen">Nguyễn Khuyến</option>
                                        <option value="ho_xuan_huong">Hồ Xuân Hương</option>
                                        <option value="nguyen_du">Nguyễn Du</option>
                                        <option value="han_mac_tu">Hàn Mặc Tử</option>
                                        <option value="xuan_quynh">Xuân Quỳnh</option>
                                    </select>
                                </div>
                                <div class="select-container mt-3">
                                    <label class="block-label">Thể loại ưu tiên</label>
                                    <select id="randomGenre">
                                        <option value="any" selected>Bất kỳ thể loại</option>
                                        <option value="tho">Thơ</option>
                                        <option value="truyen">Truyện ngắn</option>
                                        <option value="tieu_thuyet">Tiểu thuyết</option>
                                        <option value="ky">Ký</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="option-card">
                                <h3><i class="fas fa-sticky-note"></i> Ghi chú cho đề thi</h3>
                                <textarea id="examNotes" placeholder="Nhập ghi chú cho đề thi... (Ví dụ: Phân bổ thời gian, trọng tâm kiến thức, tiêu chí chấm điểm...)" rows="5"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="progress-container" id="progressContainer" style="display: none;">
                        <div class="progress-header">
                            <div class="progress-title">Đang tạo đề thi</div>
                            <div class="progress-status" id="progressStatus">Đang xử lý...</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                        </div>
                        <div class="progress-items" id="progressItems">
                        </div>
                    </div>
                    
                    <div class="exam-result-container" id="examResult" style="display: none;">
                    </div>
                </div>
            </div>
        </main>
        
        <footer class="app-footer">
            <p>Được tạo bởi <a href="https://www.facebook.com/hoangminhtuan.hmtuan" target="_blank">Hoàng Minh Tuấn</a> và <a href="https://www.facebook.com/chuong.truong.130409" target="_blank">Trương Viết Duy Chương</a></p>
        </footer>
    </div>

    <div id="previewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-file-alt mr-2"></i> XEM TRƯỚC ĐỀ THI</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body" id="previewContent">
            </div>
            <div class="modal-footer">
                <button class="modal-btn" id="printPreviewBtn">
                    <i class="fas fa-print mr-2"></i> In đề thi
                </button>
                <button class="modal-btn secondary-btn" id="closePreviewBtn">
                    <i class="fas fa-times mr-2"></i> Đóng
                </button>
            </div>
        </div>
    </div>

    <div id="editExamModal" class="modal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h3><i class="fas fa-edit mr-2"></i> CHỈNH SỬA ĐỀ THI</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="exam-editor-container" id="examEditorContainer">
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary-btn" id="cancelEditBtn">
                    <i class="fas fa-times mr-2"></i> Hủy
                </button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/quill@1.3.7/dist/quill.min.js"></script>
    <script>
        const REVERSED_API_KEY = "ADHvlJk9rfZ40q7ju_r-yVQl1ZqW4Z-MDySzAI";
        const GEMINI_API_KEY = REVERSED_API_KEY.split('').reverse().join('');

        const firebaseConfigPrimary = {
            apiKey: "AIzaSyBLZpLQKl0x-kMez2v5NURU5qSthT_6qYI",
            authDomain: "loginnn-b1dc0.firebaseapp.com",
            projectId: "loginnn-b1dc0",
            storageBucket: "loginnn-b1dc0.firebasestorage.app",
            messagingSenderId: "481800915428",
            appId: "1:481800915428:web:b524925c25efb53e7b9ff1",
            measurementId: "G-XF2ZBFBCR7"
        };

        const firebaseConfigSecondary = {
            apiKey: "AIzaSyCVD_Um0fWAK3ogQQUwCDINV_dN1hJZxL4",
            authDomain: "tkc-vanw.firebaseapp.com",
            projectId: "tkc-vanw",
            storageBucket: "tkc-vanw.firebasestorage.app",
            messagingSenderId: "862465503494",
            appId: "1:862465503494:web:8aec558b363988deec6e87",
            measurementId: "G-F23NN1KLW0"
        };

        let firestoreDbPrimary = null;
        let firestoreDbSecondary = null;
        
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfigPrimary, "primary");
            }
            
            try {
                firebase.initializeApp(firebaseConfigSecondary, "secondary");
            } catch (e) {
            }
            
            firestoreDbPrimary = firebase.app("primary").firestore();
            firestoreDbSecondary = firebase.app("secondary").firestore();
            
            [firestoreDbPrimary, firestoreDbSecondary].forEach(db => {
                db.settings({
                    ignoreUndefinedProperties: true
                });
            });
            
        } catch (error) {
            const fakeDb = {
                collection: () => ({
                    doc: () => ({
                        set: () => Promise.resolve(),
                        get: () => Promise.resolve({ 
                            exists: false, 
                            data: () => null 
                        }),
                        delete: () => Promise.resolve()
                    })
                }),
                enableNetwork: () => Promise.resolve()
            };
            
            firestoreDbPrimary = fakeDb;
            firestoreDbSecondary = fakeDb;
        }

        // Biến lưu API đang hoạt động
        let activeApiIndex = 0;
        let apiRetryCount = 0;
        const MAX_RETRY_COUNT = 2;
        
        // Danh sách các API endpoints với ưu tiên
        const API_ENDPOINTS = [
            {
                name: "Gemini API",
                url: `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`,
                model: "gemini-2.5-flash",
                priority: 1,
                active: true
            },
            {
                name: "Gemini API Flash Lite",
                url: `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${GEMINI_API_KEY}`,
                model: "gemini-2.5-flash-lite",
                priority: 2,
                active: true
            }
        ];

        let generationProgress = {
            total: 0,
            completed: 0,
            items: []
        };

        let currentExamBlocks = [];
        let currentExamCode = '';
        let examSettings = {
            time: 90,
            difficulty: 'medium',
            grade: '12',
            hasReading: true,
            hasEssay: true,
            hasPractice: false,
            questionCount: 5
        };

        let richTextEditors = [];
        let currentRealWorkInfo = null;
        let currentCreationMode = 'text';
        let blockyBlocks = [];
        let blockyEditors = [];

        window.addEventListener('error', function(e) {
            if (e.error && e.error.message && e.error.message.includes('asynchronous response')) {
            }
        });

        window.addEventListener('unhandledrejection', function(e) {
        });

        function countWords(text) {
            return text.trim().split(/\s+/).filter(word => word.length > 0).length;
        }

        function updateProgress() {
            const progressFill = document.getElementById('progressFill');
            const progressStatus = document.getElementById('progressStatus');
            const progressItems = document.getElementById('progressItems');
            
            const percent = generationProgress.total > 0 ? 
                Math.round((generationProgress.completed / generationProgress.total) * 100) : 0;
            
            progressFill.style.width = `${percent}%`;
            
            if (percent === 100) {
                progressStatus.textContent = 'Hoàn thành!';
            } else {
                progressStatus.textContent = `Đang xử lý... ${percent}%`;
            }
            
            progressItems.innerHTML = generationProgress.items.map(item => {
                let iconClass = 'fas fa-clock';
                let statusClass = 'pending';
                
                if (item.status === 'completed') {
                    iconClass = 'fas fa-check-circle';
                    statusClass = 'completed';
                } else if (item.status === 'error') {
                    iconClass = 'fas fa-exclamation-circle';
                    statusClass = 'error';
                } else if (item.status === 'verification') {
                    iconClass = 'fas fa-check-double';
                    statusClass = 'verification';
                }
                
                return `
                    <div class="progress-item ${statusClass}">
                        <i class="${iconClass}"></i>
                        ${item.name}
                    </div>
                `;
            }).join('');
        }

        function addProgressItem(name, type = 'normal') {
            generationProgress.items.push({
                name: name,
                status: 'pending',
                type: type
            });
            generationProgress.total++;
            updateProgress();
        }

        function completeProgressItem(index) {
            generationProgress.items[index].status = 'completed';
            generationProgress.completed++;
            updateProgress();
        }

        function markAsVerification(index) {
            generationProgress.items[index].status = 'verification';
            updateProgress();
        }

        function errorProgressItem(index) {
            generationProgress.items[index].status = 'error';
            generationProgress.completed++;
            updateProgress();
        }

        function formatDuration(minutes) {
            if (minutes < 60) {
                return `${minutes} phút`;
            } else {
                const hours = Math.floor(minutes / 60);
                const remainingMinutes = minutes % 60;
                return remainingMinutes > 0 ? 
                    `${hours} giờ ${remainingMinutes} phút` : 
                    `${hours} giờ`;
            }
        }

        async function callGeminiAPI(prompt, apiIndex = activeApiIndex) {
            const api = API_ENDPOINTS[apiIndex];
            if (!api || !api.active) {
                throw new Error(`API ${apiIndex} không khả dụng`);
            }

            try {
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error(`Request timeout after 90 seconds (${api.name})`)), 90000);
                });
                
                const fetchPromise = fetch(api.url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{ 
                            parts: [{ text: prompt }] 
                        }],
                        generationConfig: {
                            maxOutputTokens: 8000,
                            temperature: 0.7,
                            topP: 0.95,
                            topK: 40,
                        }
                    })
                });
                
                const response = await Promise.race([fetchPromise, timeoutPromise]);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.error?.message || 'Unknown error'}`);
                }
                
                const data = await response.json();
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content || !data.candidates[0].content.parts || !data.candidates[0].content.parts[0]) {
                    throw new Error('Invalid response format from API');
                }
                
                let result = data.candidates[0].content.parts[0].text.trim();
                
                if (result.includes('\\n')) {
                    result = result.replace(/\\n/g, '\n');
                }
                
                // Đánh dấu API hiện tại là hoạt động thành công
                activeApiIndex = apiIndex;
                apiRetryCount = 0;
                
                return result;
                
            } catch (error) {
                // Đánh dấu API hiện tại có vấn đề
                console.warn(`API ${api.name} thất bại: ${error.message}`);
                
                // Thử API tiếp theo nếu có
                if (apiIndex < API_ENDPOINTS.length - 1) {
                    const nextApiIndex = apiIndex + 1;
                    console.log(`Thử API tiếp theo: ${API_ENDPOINTS[nextApiIndex].name}`);
                    return await callGeminiAPI(prompt, nextApiIndex);
                } else {
                    // Đã thử hết tất cả API
                    throw new Error(`Tất cả API đã thất bại. Lỗi cuối cùng: ${error.message}`);
                }
            }
        }

        async function retryWithDifferentAPI(originalError, prompt) {
            apiRetryCount++;
            
            if (apiRetryCount > MAX_RETRY_COUNT) {
                throw originalError;
            }
            
            // Chuyển sang API tiếp theo
            activeApiIndex = (activeApiIndex + 1) % API_ENDPOINTS.length;
            
            console.log(`Thử lại với API khác: ${API_ENDPOINTS[activeApiIndex].name}, lần thử: ${apiRetryCount}`);
            
            try {
                return await callGeminiAPI(prompt, activeApiIndex);
            } catch (error) {
                // Nếu API mới cũng lỗi, tiếp tục thử API tiếp theo
                return await retryWithDifferentAPI(error, prompt);
            }
        }

        async function fetchGemini(prompt, maxRetries = 3) {
            try {
                // Luôn bắt đầu với API ưu tiên cao nhất (index 0)
                return await callGeminiAPI(prompt, 0);
            } catch (error) {
                // Nếu tất cả API đều thất bại, thử lại với retry logic cũ
                for (let attempt = 1; attempt <= maxRetries; attempt++) {
                    try {
                        console.log(`Thử lại lần ${attempt}/${maxRetries} với API hiện tại`);
                        return await callGeminiAPI(prompt, activeApiIndex);
                    } catch (retryError) {
                        if (attempt === maxRetries) {
                            throw new Error(`Failed after ${maxRetries} attempts: ${retryError.message}`);
                        }
                        
                        await new Promise(resolve => setTimeout(resolve, 2000 * attempt));
                    }
                }
                throw error;
            }
        }

        function processContentForStorage(content) {
            if (!content) return '';
            
            let processed = content.replace(/\n/g, '|||NEWLINE|||');
            
            processed = processed.replace(/\|\|\|NEWLINE\|\|\|\s*\|\|\|NEWLINE\|\|\|/g, '|||NEWLINE|||');
            
            return processed;
        }

        function restoreContentFromStorage(storedContent) {
            if (!storedContent) return '';
            
            let restored = storedContent.replace(/\|\|\|NEWLINE\|\|\|/g, '\n');
            
            return restored;
        }

        function displayContentWithLineBreaks(content) {
            if (!content) return '';
            
            if (content.includes('|||NEWLINE|||')) {
                return restoreContentFromStorage(content);
            }
            
            return content.replace(/\\n/g, '\n');
        }

        function markdownToHtml(text) {
            if (!text) return '';
            
            text = displayContentWithLineBreaks(text);
            
            let html = text;
            
            const lines = html.split('\n');
            html = '';
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                if (line.trim() === '') {
                    html += '<br>';
                } else if (line.startsWith('<') && line.endsWith('>')) {
                    html += line;
                } else {
                    let processedLine = line;
                    
                    processedLine = processedLine.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    
                    processedLine = processedLine.replace(/\*(.*?)\*/g, '<em>$1</em>');
                    
                    processedLine = processedLine.replace(/__(.*?)__/g, '<u>$1</u>');
                    
                    html += processedLine;
                }
                
                if (i < lines.length - 1) {
                    html += '<br>';
                }
            }
            
            return html;
        }

        async function generateExamWithGemini(text, workInfo = null) {
            let workContext = '';
            if (workInfo) {
                workContext = `
                THÔNG TIN TÁC PHẨM:
                - Tác phẩm: ${workInfo.title || 'Không xác định'}
                - Tác giả: ${workInfo.author || 'Không xác định'}
                - Thể loại: ${workInfo.genre || 'Không xác định'}
                `;
            }
            
            const prompt = `
                Tạo một đề thi Ngữ Văn CHỈ DỰA TRÊN TÁC PHẨM VĂN HỌC CÓ THẬT.
                
                ${workContext}
                
                VĂN BẢN TÁC PHẨM (giữ nguyên định dạng xuống dòng, đặc biệt với thơ):
                ${text}
                
                THÔNG TIN ĐỀ THI:
                - Thời gian: ${examSettings.time} phút
                - Độ khó: ${examSettings.difficulty}
                - Khối lớp: ${examSettings.grade}
                - Số câu hỏi: ${examSettings.questionCount}
                - Phần đọc hiểu: ${examSettings.hasReading ? 'CÓ' : 'KHÔNG'}
                - Phần nghị luận: ${examSettings.hasEssay ? 'CÓ' : 'KHÔNG'}
                - Phần liên hệ thực tế: ${examSettings.hasPractice ? 'CÓ' : 'KHÔNG'}
                
                YÊU CẦU QUAN TRỌNG:
                1. CHỈ sử dụng tác phẩm văn học có thật trong chương trình học
                2. Giữ nguyên định dạng xuống dòng của văn bản, đặc biệt với THƠ
                3. Tạo đề thi phù hợp với chương trình giáo dục Việt Nam
                4. Đảm bảo tính chính xác của thông tin tác phẩm
                
                Định dạng trả về JSON:
                {
                    "title": "Tiêu đề đề thi",
                    "description": "Mô tả ngắn về đề thi",
                    "workInfo": {
                        "title": "Tên tác phẩm",
                        "author": "Tác giả",
                        "genre": "Thể loại"
                    },
                    "blocks": [
                        {
                            "type": "text",
                            "title": "Phần I: ĐỌC HIỂU",
                            "content": "Đoạn văn bản cho phần đọc hiểu...",
                            "points": 0
                        },
                        {
                            "type": "question",
                            "title": "Câu hỏi 1",
                            "content": "Nêu nội dung chính của đoạn văn trên?",
                            "points": 1.0
                        }
                    ]
                }
                
                LƯU Ý: Giữ nguyên \\n cho xuống dòng trong nội dung văn bản!
            `;

            try {
                // Sử dụng hàm callGeminiAPI mới với logic chuyển đổi API
                const resultText = await callGeminiAPI(prompt);
                
                const jsonMatch = resultText.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const examData = JSON.parse(jsonMatch[0]);
                    
                    if (examData.blocks) {
                        examData.blocks.forEach(block => {
                            if (block.content) {
                                block.content = processContentForStorage(block.content);
                            }
                        });
                    }
                    
                    if (!examData.workInfo && workInfo) {
                        examData.workInfo = workInfo;
                    }
                    
                    return examData;
                } else {
                    return {
                        title: "ĐỀ THI NGỮ VĂN",
                        description: "Đề thi được tạo từ tác phẩm văn học có thật",
                        workInfo: workInfo || {
                            title: "Tác phẩm văn học",
                            author: "Tác giả",
                            genre: "Văn học"
                        },
                        blocks: [
                            {
                                type: "text",
                                title: "Phần I: ĐỌC HIỂU",
                                content: processContentForStorage(text.substring(0, 500)),
                                points: 0
                            },
                            {
                                type: "question",
                                title: "Câu hỏi 1",
                                content: processContentForStorage("**Nêu nội dung chính** của đoạn văn trên?"),
                                points: 1.0
                            }
                        ]
                    };
                }
            } catch (error) {
                // Nếu có lỗi trong quá trình xử lý, thử lại với API khác
                console.error('Lỗi khi gọi Gemini API:', error);
                
                try {
                    // Thử lại với API khác
                    const resultText = await retryWithDifferentAPI(error, prompt);
                    
                    const jsonMatch = resultText.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const examData = JSON.parse(jsonMatch[0]);
                        
                        if (examData.blocks) {
                            examData.blocks.forEach(block => {
                                if (block.content) {
                                    block.content = processContentForStorage(block.content);
                                }
                            });
                        }
                        
                        if (!examData.workInfo && workInfo) {
                            examData.workInfo = workInfo;
                        }
                        
                        return examData;
                    }
                } catch (retryError) {
                    throw new Error('Lỗi kết nối với Gemini API: ' + retryError.message);
                }
                
                throw new Error('Lỗi kết nối với Gemini API: ' + error.message);
            }
        }

        async function generateExamFromAIPrompt(promptText) {
            const fullPrompt = `
                Tạo một đề thi Ngữ Văn hoàn chỉnh dựa trên yêu cầu sau:
                
                YÊU CẦU CỦA NGƯỜI DÙNG: ${promptText}
                
                THÔNG TIN ĐỀ THI:
                - Thời gian: ${examSettings.time} phút
                - Độ khó: ${examSettings.difficulty}
                - Khối lớp: ${examSettings.grade}
                - Số câu hỏi: ${examSettings.questionCount}
                - Phần đọc hiểu: ${examSettings.hasReading ? 'CÓ' : 'KHÔNG'}
                - Phần nghị luận: ${examSettings.hasEssay ? 'CÓ' : 'KHÔNG'}
                - Phần liên hệ thực tế: ${examSettings.hasPractice ? 'CÓ' : 'KHÔNG'}
                
                YÊU CẦU QUAN TRỌNG:
                1. PHẢI sử dụng tác phẩm văn học có thật trong chương trình Ngữ Văn Việt Nam
                2. Giữ nguyên định dạng xuống dòng của văn bản, đặc biệt với THƠ
                3. Tạo đề thi phù hợp với chương trình giáo dục Việt Nam
                4. Bao gồm cả văn bản đọc hiểu và câu hỏi
                5. Đảm bảo tính chính xác của thông tin tác phẩm
                
                Định dạng trả về JSON:
                {
                    "title": "Tiêu đề đề thi",
                    "description": "Mô tả ngắn về đề thi",
                    "workInfo": {
                        "title": "Tên tác phẩm",
                        "author": "Tác giả",
                        "genre": "Thể loại"
                    },
                    "blocks": [
                        {
                            "type": "text",
                            "title": "Phần I: ĐỌC HIỂU",
                            "content": "Đoạn văn bản cho phần đọc hiểu...",
                            "points": 0
                        },
                        {
                            "type": "question",
                            "title": "Câu hỏi 1",
                            "content": "Nêu nội dung chính của đoạn văn trên?",
                            "points": 1.0
                        }
                    ]
                }
                
                LƯU Ý: Giữ nguyên \\n cho xuống dòng trong nội dung văn bản!
            `;

            try {
                // Sử dụng hàm callGeminiAPI mới
                const resultText = await callGeminiAPI(fullPrompt);
                
                const jsonMatch = resultText.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const examData = JSON.parse(jsonMatch[0]);
                    
                    if (examData.blocks) {
                        examData.blocks.forEach(block => {
                            if (block.content) {
                                block.content = processContentForStorage(block.content);
                            }
                        });
                    }
                    
                    return examData;
                } else {
                    throw new Error('Không thể phân tích phản hồi từ AI');
                }
            } catch (error) {
                // Thử lại với API khác
                try {
                    const resultText = await retryWithDifferentAPI(error, fullPrompt);
                    
                    const jsonMatch = resultText.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const examData = JSON.parse(jsonMatch[0]);
                        
                        if (examData.blocks) {
                            examData.blocks.forEach(block => {
                                if (block.content) {
                                    block.content = processContentForStorage(block.content);
                                }
                            });
                        }
                        
                        return examData;
                    } else {
                        throw new Error('Không thể phân tích phản hồi từ AI');
                    }
                } catch (retryError) {
                    throw new Error('Lỗi kết nối với Gemini API: ' + retryError.message);
                }
            }
        }

        async function generateRandomTextSample() {
            const author = document.getElementById('randomAuthor').value;
            const genre = document.getElementById('randomGenre').value;
            
            let prompt = '';
            
            if (author !== 'random') {
                const authorMap = {
                    'xuan_dieu': 'Xuân Diệu',
                    'nam_cao': 'Nam Cao',
                    'thach_lam': 'Thạch Lam',
                    'to_hoai': 'Tô Hoài',
                    'nguyen_tuan': 'Nguyễn Tuân',
                    'nguyen_khuyen': 'Nguyễn Khuyến',
                    'ho_xuan_huong': 'Hồ Xuân Hương',
                    'nguyen_du': 'Nguyễn Du',
                    'han_mac_tu': 'Hàn Mặc Tử',
                    'xuan_quynh': 'Xuân Quỳnh'
                };
                
                const authorName = authorMap[author] || 'Tác giả';
                const genreName = genre === 'any' ? '' : `thuộc thể loại ${genre}`;
                
                prompt = `
                    Hãy cung cấp một đoạn trích từ TÁC PHẨM VĂN HỌC CÓ THẬT trong chương trình Ngữ Văn Việt Nam của tác giả ${authorName} ${genreName}.
                    
                    YÊU CẦU QUAN TRỌNG:
                    1. PHẢI là tác phẩm có thật, không tự sáng tác
                    2. Ghi rõ: Tên tác phẩm, tác giả, thể loại
                    3. Chọn đoạn trích tiêu biểu, có giá trị văn học
                    4. Giữ nguyên định dạng gốc (xuống dòng cho thơ, đoạn văn cho văn xuôi)
                    5. Độ dài khoảng 300-500 từ
                    6. Phù hợp làm đề thi học sinh
                    
                    Định dạng trả về:
                    TÁC PHẨM: [Tên tác phẩm]
                    TÁC GIẢ: ${authorName}
                    THỂ LOẠI: [Thể loại]
                    
                    [Nội dung đoạn trích]
                    
                    Lưu ý: KHÔNG thêm bình luận hay giải thích gì thêm
                `;
            } else {
                const genreMap = {
                    'any': 'văn học',
                    'tho': 'thơ',
                    'truyen': 'truyện ngắn',
                    'tieu_thuyet': 'tiểu thuyết',
                    'ky': 'ký'
                };
                
                const genreName = genreMap[genre] || 'văn học';
                
                prompt = `
                    Hãy cung cấp một đoạn trích từ TÁC PHẨM VĂN HỌC CÓ THẬT trong chương trình Ngữ Văn Việt Nam thuộc thể loại ${genreName}.
                    
                    YÊU CẦU QUAN TRỌNG:
                    1. PHẢI là tác phẩm có thật, không tự sáng tác
                    2. Ghi rõ: Tên tác phẩm, tác giả, thể loại
                    3. Chọn đoạn trích tiêu biểu, có giá trị văn học
                    4. Giữ nguyên định dạng gốc (xuống dòng cho thơ, đoạn văn cho văn xuôi)
                    5. Độ dài khoảng 300-500 từ
                    6. Phù hợp làm đề thi học sinh
                    
                    Định dạng trả về:
                    TÁC PHẨM: [Tên tác phẩm]
                    TÁC GIẢ: [Tên tác giả]
                    THỂ LOẠI: [Thể loại]
                    
                    [Nội dung đoạn trích]
                    
                    Lưu ý: KHÔNG thêm bình luận hay giải thích gì thêm
                `;
            }
            
            try {
                addProgressItem('Đang tải tác phẩm ngẫu nhiên...');
                
                // Sử dụng hàm callGeminiAPI mới
                const result = await callGeminiAPI(prompt);
                completeProgressItem(0);
                
                const lines = result.split('\n');
                const workInfo = {
                    title: '',
                    author: '',
                    genre: '',
                    content: ''
                };
                
                let contentStarted = false;
                let contentLines = [];
                
                for (const line of lines) {
                    if (line.startsWith('TÁC PHẨM:')) {
                        workInfo.title = line.replace('TÁC PHẨM:', '').trim();
                    } else if (line.startsWith('TÁC GIẢ:')) {
                        workInfo.author = line.replace('TÁC GIẢ:', '').trim();
                    } else if (line.startsWith('THỂ LOẠI:')) {
                        workInfo.genre = line.replace('THỂ LOẠI:', '').trim();
                    } else if (line.trim() === '' && workInfo.title && !contentStarted) {
                        contentStarted = true;
                    } else if (contentStarted) {
                        contentLines.push(line);
                    }
                }
                
                workInfo.content = processContentForStorage(contentLines.join('\n').trim());
                
                if (!workInfo.title) workInfo.title = "Tác phẩm văn học";
                if (!workInfo.author) workInfo.author = "Tác giả";
                if (!workInfo.genre) workInfo.genre = "Văn học";
                
                currentRealWorkInfo = workInfo;
                
                return workInfo.content;
            } catch (error) {
                // Nếu API thất bại, dùng dữ liệu mẫu
                console.error('Lỗi khi tải tác phẩm ngẫu nhiên:', error);
                
                try {
                    // Thử lại với API khác
                    const result = await retryWithDifferentAPI(error, prompt);
                    completeProgressItem(0);
                    
                    const lines = result.split('\n');
                    const workInfo = {
                        title: '',
                        author: '',
                        genre: '',
                        content: ''
                    };
                    
                    let contentStarted = false;
                    let contentLines = [];
                    
                    for (const line of lines) {
                        if (line.startsWith('TÁC PHẨM:')) {
                            workInfo.title = line.replace('TÁC PHẨM:', '').trim();
                        } else if (line.startsWith('TÁC GIẢ:')) {
                            workInfo.author = line.replace('TÁC GIẢ:', '').trim();
                        } else if (line.startsWith('THỂ LOẠI:')) {
                            workInfo.genre = line.replace('THỂ LOẠI:', '').trim();
                        } else if (line.trim() === '' && workInfo.title && !contentStarted) {
                            contentStarted = true;
                        } else if (contentStarted) {
                            contentLines.push(line);
                        }
                    }
                    
                    workInfo.content = processContentForStorage(contentLines.join('\n').trim());
                    
                    if (!workInfo.title) workInfo.title = "Tác phẩm văn học";
                    if (!workInfo.author) workInfo.author = "Tác giả";
                    if (!workInfo.genre) workInfo.genre = "Văn học";
                    
                    currentRealWorkInfo = workInfo;
                    
                    return workInfo.content;
                } catch (retryError) {
                    // Dùng dữ liệu mẫu nếu tất cả API đều thất bại
                    errorProgressItem(0);
                    
                    currentRealWorkInfo = {
                        title: "Chí Phèo",
                        author: "Nam Cao",
                        genre: "Truyện ngắn",
                        content: processContentForStorage("Hắn vừa đi vừa chửi. Bao giờ cũng thế, cứ rượu xong là hắn chửi. Bắt đầu hắn chửi trời. Có hề gì? Trời có của riêng nhà nào? Rồi hắn chửi đời. Thế cũng chẳng sao: đời là tất cả nhưng chẳng là ai...")
                    };
                    
                    return currentRealWorkInfo.content;
                }
            }
        }

        async function generateRandomExam() {
            const generateRandomBtn = document.getElementById('generateRandomExamBtn');
            const progressContainer = document.getElementById('progressContainer');
            const examResult = document.getElementById('examResult');

            generateRandomBtn.disabled = true;
            generateRandomBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Đang tạo đề thi ngẫu nhiên...';
            progressContainer.style.display = 'block';
            examResult.style.display = 'none';
            
            generationProgress = {
                total: 0,
                completed: 0,
                items: []
            };
            
            examResult.innerHTML = '';

            try {
                examSettings = {
                    time: parseInt(document.getElementById('examTimeSlider').value),
                    difficulty: document.getElementById('difficulty').value,
                    grade: document.getElementById('grade').value,
                    hasReading: document.getElementById('readingToggle').checked,
                    hasEssay: document.getElementById('essayToggle').checked,
                    hasPractice: document.getElementById('practiceToggle').checked,
                    questionCount: parseInt(document.getElementById('questionCount').value)
                };
                
                const examNotes = document.getElementById('examNotes').value;

                addProgressItem('Đang chọn tác phẩm ngẫu nhiên');
                addProgressItem('Thực hiện tự kiểm chứng tác phẩm', 'verification');
                addProgressItem('Tạo câu hỏi đề thi');
                addProgressItem('Hoàn thiện cấu trúc đề');

                const randomText = await generateRandomTextSample();
                completeProgressItem(0);

                markAsVerification(1);
                await new Promise(resolve => setTimeout(resolve, 1000));
                completeProgressItem(1);

                const examData = await generateExamWithGemini(randomText, currentRealWorkInfo);
                completeProgressItem(2);

                showExamResult(examData, examNotes);
                completeProgressItem(3);

                examResult.style.display = 'block';

            } catch (error) {
                let errorMessage = 'Đã xảy ra lỗi khi tạo đề thi ngẫu nhiên. ';
                if (error.message.includes('timeout')) {
                    errorMessage += 'Yêu cầu mất quá nhiều thời gian. Vui lòng thử lại.';
                } else if (error.message.includes('Failed after')) {
                    errorMessage += 'Không thể kết nối đến AI. Vui lòng kiểm tra kết nối internet và thử lại.';
                } else if (error.message.includes('Tất cả API đã thất bại')) {
                    errorMessage += 'Tất cả các API đều không hoạt động. Vui lòng thử lại sau.';
                } else {
                    errorMessage += error.message;
                }
                
                examResult.innerHTML = `
                    <div class="exam-info" style="background: rgba(239, 68, 68, 0.1); border-color: #ef4444;">
                        <h3 style="color: #ef4444;"><i class="fas fa-exclamation-triangle"></i> Lỗi khi tạo đề thi ngẫu nhiên</h3>
                        <p>${errorMessage}</p>
                        <p><strong>API đang sử dụng:</strong> ${API_ENDPOINTS[activeApiIndex]?.name || 'Không xác định'}</p>
                        <p><strong>Gợi ý:</strong></p>
                        <ul>
                            <li>Kiểm tra kết nối internet</li>
                            <li>Thử lại với tác giả khác</li>
                            <li>Thử lại sau vài phút</li>
                            <li>Hệ thống sẽ tự động thử API khác nếu có lỗi</li>
                        </ul>
                    </div>
                `;
                
                examResult.style.display = 'block';
                
                if (generationProgress.items.length > 0) {
                    const lastIndex = generationProgress.items.length - 1;
                    errorProgressItem(lastIndex);
                }
            } finally {
                generateRandomBtn.disabled = false;
                generateRandomBtn.innerHTML = '<i class="fas fa-dice mr-2"></i> Đề Thi Ngẫu Nhiên';
            }
        }

        async function generateExam() {
            let examData;
            const progressContainer = document.getElementById('progressContainer');
            const examResult = document.getElementById('examResult');
            const generateBtn = document.getElementById('generateExamBtn');

            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Đang tạo đề thi...';
            progressContainer.style.display = 'block';
            examResult.style.display = 'none';
            
            generationProgress = {
                total: 0,
                completed: 0,
                items: []
            };
            
            examResult.innerHTML = '';

            try {
                examSettings = {
                    time: parseInt(document.getElementById('examTimeSlider').value),
                    difficulty: document.getElementById('difficulty').value,
                    grade: document.getElementById('grade').value,
                    hasReading: document.getElementById('readingToggle').checked,
                    hasEssay: document.getElementById('essayToggle').checked,
                    hasPractice: document.getElementById('practiceToggle').checked,
                    questionCount: parseInt(document.getElementById('questionCount').value)
                };
                
                const examNotes = document.getElementById('examNotes').value;

                if (currentCreationMode === 'text') {
                    const text = document.getElementById('inputText').value.trim();
                    
                    if (!text) {
                        throw new Error('Vui lòng nhập nội dung văn bản!');
                    }
                    
                    const wordCount = countWords(text);
                    if (wordCount < 20) {
                        throw new Error(`Văn bản quá ngắn (${wordCount} từ)! Vui lòng nhập ít nhất 20 từ.`);
                    }

                    addProgressItem('Phân tích văn bản');
                    addProgressItem('Thực hiện tự kiểm chứng tác phẩm', 'verification');
                    addProgressItem('Tạo câu hỏi đề thi');
                    addProgressItem('Hoàn thiện cấu trúc đề');

                    const textTypeResponse = await callGeminiAPI(
                        `Xác định thể loại chính xác của văn bản sau (chỉ trả về 1-3 từ): "${text.substring(0, 800)}"`
                    );
                    completeProgressItem(0);

                    markAsVerification(1);
                    
                    let workInfo = currentRealWorkInfo;
                    
                    if (!workInfo) {
                        const verificationPrompt = `
                            Văn bản sau có phải là tác phẩm văn học có thật trong chương trình Ngữ Văn Việt Nam không?
                            Trả lời ngắn gọn: CÓ hoặc KHÔNG
                            
                            Văn bản: "${text.substring(0, 500)}"
                        `;
                        
                        try {
                            const verificationResult = await callGeminiAPI(verificationPrompt);
                            if (verificationResult.includes('CÓ') || verificationResult.includes('có')) {
                                workInfo = {
                                    title: "Tác phẩm văn học",
                                    author: "Tác giả",
                                    genre: textTypeResponse.trim()
                                };
                            }
                        } catch (e) {
                            // Bỏ qua lỗi xác minh
                        }
                    }
                    
                    completeProgressItem(1);

                    examData = await generateExamWithGemini(text, workInfo);
                    completeProgressItem(2);

                    showExamResult(examData, examNotes);
                    completeProgressItem(3);

                } else if (currentCreationMode === 'ai') {
                    const prompt = document.getElementById('aiPrompt').value.trim();
                    
                    if (!prompt) {
                        throw new Error('Vui lòng nhập yêu cầu cho AI!');
                    }

                    addProgressItem('Đang phân tích yêu cầu');
                    addProgressItem('Tìm kiếm tác phẩm phù hợp', 'verification');
                    addProgressItem('Tạo nội dung đề thi');
                    addProgressItem('Hoàn thiện cấu trúc đề');

                    completeProgressItem(0);

                    markAsVerification(1);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    completeProgressItem(1);

                    examData = await generateExamFromAIPrompt(prompt);
                    completeProgressItem(2);

                    showExamResult(examData, examNotes);
                    completeProgressItem(3);

                } else if (currentCreationMode === 'blocky') {
                    if (blockyBlocks.length === 0) {
                        throw new Error('Vui lòng thêm ít nhất một khối nội dung!');
                    }

                    addProgressItem('Đang xử lý các khối nội dung');
                    addProgressItem('Kiểm tra tính hợp lệ', 'verification');
                    addProgressItem('Hoàn thiện đề thi');

                    completeProgressItem(0);

                    markAsVerification(1);
                    await new Promise(resolve => setTimeout(resolve, 500));
                    completeProgressItem(1);

                    examData = {
                        title: "ĐỀ THI NGỮ VĂN",
                        description: "Đề thi được tạo bằng chế độ Blocky",
                        workInfo: currentRealWorkInfo || {
                            title: "Tác phẩm tổng hợp",
                            author: "Nhiều tác giả",
                            genre: "Văn học tổng hợp"
                        },
                        blocks: blockyBlocks.map((block, index) => ({
                            type: block.type,
                            title: block.title || (block.type === 'text' ? `Phần văn bản ${index + 1}` : `Câu hỏi ${index + 1}`),
                            content: processContentForStorage(block.content || ''),
                            points: block.points || (block.type === 'question' ? 1.0 : 0)
                        }))
                    };

                    showExamResult(examData, examNotes);
                    completeProgressItem(2);
                }

                examResult.style.display = 'block';

            } catch (error) {
                let errorMessage = 'Đã xảy ra lỗi khi tạo đề thi. ';
                if (error.message.includes('timeout')) {
                    errorMessage += 'Yêu cầu mất quá nhiều thời gian. Vui lòng thử lại.';
                } else if (error.message.includes('Failed after')) {
                    errorMessage += 'Không thể kết nối đến AI. Vui lòng kiểm tra kết nối internet và thử lại.';
                } else if (error.message.includes('Tất cả API đã thất bại')) {
                    errorMessage += 'Tất cả các API đều không hoạt động. Vui lòng thử lại sau.';
                } else {
                    errorMessage += error.message;
                }
                
                examResult.innerHTML = `
                    <div class="exam-info" style="background: rgba(239, 68, 68, 0.1); border-color: #ef4444;">
                        <h3 style="color: #ef4444;"><i class="fas fa-exclamation-triangle"></i> Lỗi khi tạo đề thi</h3>
                        <p>${errorMessage}</p>
                        <p><strong>API đang sử dụng:</strong> ${API_ENDPOINTS[activeApiIndex]?.name || 'Không xác định'}</p>
                        <p><strong>Số lần thử lại:</strong> ${apiRetryCount}</p>
                        <p><strong>Gợi ý:</strong></p>
                        <ul>
                            <li>Kiểm tra kết nối internet</li>
                            <li>Thử lại với nội dung khác</li>
                            <li>Thử lại sau vài phút</li>
                            <li>Hệ thống sẽ tự động thử API khác nếu có lỗi</li>
                        </ul>
                    </div>
                `;
                
                examResult.style.display = 'block';
                
                if (generationProgress.items.length > 0) {
                    const lastIndex = generationProgress.items.length - 1;
                    errorProgressItem(lastIndex);
                }
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-file-alt mr-2"></i> Tạo Đề Thi';
            }
        }

        function showExamResult(examData, examNotes) {
            currentExamBlocks = examData.blocks || [];
            currentExamCode = generateExamCode();
            
            currentExamBlocks.forEach(block => {
                if (block.content && typeof block.content === 'string') {
                    block.content = displayContentWithLineBreaks(block.content);
                }
            });
            
            let examNotesHTML = '';
            if (examNotes.trim()) {
                examNotesHTML = `
                    <div style="background: rgba(227, 124, 45, 0.05); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid var(--primary-color);">
                        <h4 style="margin: 0 0 0.5rem 0; color: var(--primary-color);">
                            <i class="fas fa-sticky-note"></i> Ghi chú đề thi
                        </h4>
                        <p style="margin: 0; line-height: 1.6; white-space: pre-wrap;">${examNotes}</p>
                    </div>
                `;
            }
            
            let workInfoHTML = '';
            if (examData.workInfo) {
                workInfoHTML = `
                    <div style="background: rgba(76, 175, 80, 0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #4CAF50;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #2E7D32;">
                            <i class="fas fa-book"></i> THÔNG TIN TÁC PHẨM
                        </h4>
                        <p style="margin: 0; line-height: 1.6;">
                            <strong>Tác phẩm:</strong> ${examData.workInfo.title || 'Không xác định'}<br>
                            <strong>Tác giả:</strong> ${examData.workInfo.author || 'Không xác định'}<br>
                            <strong>Thể loại:</strong> ${examData.workInfo.genre || 'Văn học'}
                        </p>
                    </div>
                `;
            }
            
            let previewHTML = `
                <div class="exam-header">
                    <h3><i class="fas fa-file-alt mr-2"></i> ${examData.title || 'ĐỀ THI NGỮ VĂN'}</h3>
                    <div class="exam-code">
                        Mã đề: <span id="examCodeSpan">${currentExamCode}</span>
                    </div>
                </div>
                
                <div class="exam-info">
                    <p><strong>Thời gian:</strong> ${examSettings.time} phút | <strong>Độ khó:</strong> ${examSettings.difficulty === 'easy' ? 'Dễ' : examSettings.difficulty === 'medium' ? 'Trung bình' : 'Khó'} | <strong>Khối lớp:</strong> ${examSettings.grade}</p>
                    <p>${examData.description || 'Đề thi được tạo từ tác phẩm văn học có thật'}</p>
                </div>
                
                ${workInfoHTML}
                ${examNotesHTML}
                
                <div class="preview-exam">
            `;
            
            let questionCounter = 1;
            let totalPoints = 0;
            
            currentExamBlocks.forEach((block, index) => {
                if (block.type === 'text') {
                    previewHTML += `
                        <div class="exam-section">
                            <h3 class="section-title">${block.title || 'Phần văn bản'}</h3>
                            <div class="text-content markdown-content" style="white-space: pre-wrap; font-family: 'Times New Roman', Times, serif;">${markdownToHtml(block.content)}</div>
                        </div>
                    `;
                } else if (block.type === 'question') {
                    totalPoints += block.points || 0;
                    previewHTML += `
                        <div class="question-item">
                            <div class="question-header">
                                <div class="question-text markdown-content"><strong>Câu ${questionCounter}:</strong> ${markdownToHtml(block.content)}</div>
                                <div class="question-points">${block.points || 1.0} điểm</div>
                            </div>
                            <div class="answer-area">
                                <textarea class="answer-textarea" placeholder="Thí sinh viết câu trả lời vào đây..." rows="4" style="white-space: pre-wrap;"></textarea>
                            </div>
                        </div>
                    `;
                    questionCounter++;
                }
            });
            
            previewHTML += `
                <div class="exam-info" style="margin-top: 2rem; padding-top: 1rem; border-top: 2px solid var(--card-outline);">
                    <p><strong>Tổng điểm: ${totalPoints.toFixed(1)} điểm</strong></p>
                    <p><em>--- Hết đề thi ---</em></p>
                </div>
            `;
            
            previewHTML += `</div>`;
            
            const examActions = `
                <div class="exam-actions">
                    <button id="previewExamBtn" class="exam-action-btn preview-btn">
                        <i class="fas fa-eye mr-2"></i> Xem trước
                    </button>
                    <button id="editExamBtn" class="exam-action-btn edit-btn">
                        <i class="fas fa-edit mr-2"></i> Chỉnh sửa
                    </button>
                    <button id="saveExamBtn" class="exam-action-btn save-btn">
                        <i class="fas fa-save mr-2"></i> Lưu đề thi
                    </button>
                    <button id="printExamBtn" class="exam-action-btn print-btn">
                        <i class="fas fa-print mr-2"></i> In đề thi
                    </button>
                    <button id="saveExamToDatabase" class="exam-action-btn" style="background: linear-gradient(135deg, #FF9800, #F57C00);">
                        <i class="fas fa-database mr-2"></i> Lưu vào Database
                    </button>
                    <button id="testDbBtn" class="exam-action-btn" style="background: linear-gradient(135deg, #9E9E9E, #757575);">
                        <i class="fas fa-plug mr-2"></i> Kiểm tra DB
                    </button>
                </div>
            `;
            
            document.getElementById('examResult').innerHTML = previewHTML + examActions;
            
            document.getElementById('previewExamBtn')?.addEventListener('click', updateExamPreview);
            document.getElementById('editExamBtn')?.addEventListener('click', openExamEditor);
            document.getElementById('saveExamBtn')?.addEventListener('click', saveExam);
            document.getElementById('printExamBtn')?.addEventListener('click', printExam);
            document.getElementById('saveExamToDatabase')?.addEventListener('click', saveExamToDatabase);
            document.getElementById('testDbBtn')?.addEventListener('click', testDatabaseConnection);
        }

        function generateExamCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        async function testDatabaseConnection() {
            try {
                if (firestoreDbPrimary) {
                    const testRef1 = firestoreDbPrimary.collection('_connection_tests').doc('test_' + Date.now());
                    await testRef1.set({
                        test: true,
                        timestamp: new Date().toISOString(),
                        db: 'primary'
                    });
                    
                    setTimeout(() => {
                        testRef1.delete().catch(() => {});
                    }, 5000);
                }
                
                if (firestoreDbSecondary) {
                    const testRef2 = firestoreDbSecondary.collection('_connection_tests').doc('test_' + Date.now());
                    await testRef2.set({
                        test: true,
                        timestamp: new Date().toISOString(),
                        db: 'secondary'
                    });
                    
                    setTimeout(() => {
                        testRef2.delete().catch(() => {});
                    }, 5000);
                }
                
            } catch (error) {
            }
        }

        async function saveExamToDatabase() {
            try {
                updateExamFromEditor();
                
                const examNotes = document.getElementById('examNotes').value;
                
                const totalPoints = currentExamBlocks.reduce((sum, block) => sum + (block.points || 0), 0);
                
                const examDataToSave = {
                    examId: currentExamCode,
                    title: "Đề thi Ngữ Văn",
                    literaryText: document.getElementById('inputText')?.value.substring(0, 500) || '',
                    examTime: examSettings.time,
                    difficulty: examSettings.difficulty,
                    grade: examSettings.grade,
                    notes: examNotes,
                    blocks: JSON.parse(JSON.stringify(currentExamBlocks)),
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    totalPoints: totalPoints,
                    source: "VANW Exam Tool",
                    status: "active",
                    isRealWork: !!currentRealWorkInfo,
                    workInfo: currentRealWorkInfo || null,
                    creationMode: currentCreationMode,
                    apiUsed: API_ENDPOINTS[activeApiIndex]?.name || 'Unknown'
                };
                
                examDataToSave.blocks.forEach(block => {
                    if (block.content && typeof block.content === 'string') {
                        block.content = processContentForStorage(block.content);
                    }
                });
                
                const savePromises = [];
                
                if (firestoreDbPrimary) {
                    savePromises.push(
                        firestoreDbPrimary.collection('exams').doc(currentExamCode)
                            .set(examDataToSave, { merge: true })
                    );
                }
                
                if (firestoreDbSecondary) {
                    savePromises.push(
                        firestoreDbSecondary.collection('vanw_exams').doc(currentExamCode)
                            .set(examDataToSave, { merge: true })
                    );
                }
                
                await Promise.all(savePromises);
                
                const savedDoc1 = firestoreDbPrimary ? 
                    await firestoreDbPrimary.collection('exams').doc(currentExamCode).get() : 
                    { exists: false };
                
                const savedDoc2 = firestoreDbSecondary ? 
                    await firestoreDbSecondary.collection('vanw_exams').doc(currentExamCode).get() : 
                    { exists: false };
                
                if (savedDoc1.exists || savedDoc2.exists) {
                    
                    const link = `${window.location.origin}/take_exam.html?code=${currentExamCode}`;
                    
                    setTimeout(() => {
                        navigator.clipboard.writeText(link).then(() => {
                        }).catch(() => {
                        });
                    }, 1000);
                    
                    const backupExams = JSON.parse(localStorage.getItem('vanw_exams_backup') || '{}');
                    backupExams[currentExamCode] = {
                        ...examDataToSave,
                        localBackup: true,
                        backupDate: new Date().toISOString()
                    };
                    localStorage.setItem('vanw_exams_backup', JSON.stringify(backupExams));
                    
                } else {
                    throw new Error('Không thể xác nhận dữ liệu đã được lưu');
                }
                
            } catch (error) {
                try {
                    const localExams = JSON.parse(localStorage.getItem('vanw_exams_local') || '{}');
                    localExams[currentExamCode] = {
                        examId: currentExamCode,
                        title: "Đề thi Ngữ Văn",
                        blocks: currentExamBlocks.map(block => ({
                            ...block,
                            content: processContentForStorage(block.content)
                        })),
                        examTime: examSettings.time,
                        difficulty: examSettings.difficulty,
                        grade: examSettings.grade,
                        isRealWork: !!currentRealWorkInfo,
                        workInfo: currentRealWorkInfo,
                        savedAt: new Date().toISOString(),
                        reason: "Firestore failed, saved locally",
                        apiUsed: API_ENDPOINTS[activeApiIndex]?.name || 'Unknown'
                    };
                    localStorage.setItem('vanw_exams_local', JSON.stringify(localExams));
                    
                } catch (localError) {
                }
            }
        }

        function openExamEditor() {
            const modal = document.getElementById('editExamModal');
            const editorContainer = document.getElementById('examEditorContainer');
            
            editorContainer.innerHTML = createExamEditorHTML();
            
            setTimeout(() => {
                initRichTextEditors();
                initAutoUpdate();
            }, 100);
            
            modal.classList.add('active');
        }

        function createExamEditorHTML() {
            let editorHTML = `
                <div class="exam-editor-container">
                    <div class="editor-actions">
                        <button id="addTextBlockBtn" class="editor-action-btn">
                            <i class="fas fa-paragraph mr-2"></i> Thêm phần văn bản
                        </button>
                        <button id="addQuestionBlockBtn" class="editor-action-btn">
                            <i class="fas fa-question-circle mr-2"></i> Thêm câu hỏi
                        </button>
                        <button id="reorderBlocksBtn" class="editor-action-btn">
                            <i class="fas fa-sort mr-2"></i> Sắp xếp lại
                        </button>
                    </div>
                    
                    <!-- Preview area -->
                    <div id="editorPreviewArea" style="margin-bottom: 1.5rem; border: 2px solid var(--card-outline); border-radius: 8px; padding: 1rem; background: rgba(0, 0, 0, 0.02);">
                        <h4 style="color: var(--primary-color); margin-bottom: 1rem; border-bottom: 1px solid var(--card-outline); padding-bottom: 0.5rem;">
                            <i class="fas fa-eye mr-2"></i> XEM TRƯỚC ĐỀ THI
                        </h4>
                        <div id="editorPreviewContent">
                            <p style="color: var(--text-secondary); text-align: center; padding: 1rem;">
                                Thay đổi sẽ được hiển thị tự động tại đây...
                            </p>
                        </div>
                    </div>
                    
                    <div class="exam-blocks-container" id="examBlocksContainer">
            `;
            
            currentExamBlocks.forEach((block, index) => {
                editorHTML += createBlockEditorHTML(block, index);
            });
            
            editorHTML += `
                    </div>
                    
                    <div class="exam-actions" style="margin-top: 2rem;">
                        <button id="saveEditedExamBtn" class="exam-action-btn save-btn">
                            <i class="fas fa-save mr-2"></i> Lưu thay đổi
                        </button>
                    </div>
                </div>
            `;
            
            return editorHTML;
        }

        function createBlockEditorHTML(block, index) {
            let content = block.content || '';
            content = displayContentWithLineBreaks(content);
            
            return `
                <div class="exam-block-editor" data-index="${index}" style="margin-bottom: 1.5rem; border: 2px solid var(--card-outline); border-radius: 8px; padding: 1rem;">
                    <div class="block-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <select class="block-type-select" data-index="${index}" style="padding: 0.5rem; border-radius: 4px; border: 1px solid var(--card-outline);">
                            <option value="text" ${block.type === 'text' ? 'selected' : ''}>Phần văn bản</option>
                            <option value="question" ${block.type === 'question' ? 'selected' : ''}>Câu hỏi</option>
                        </select>
                        
                        <div class="block-actions">
                            <button class="block-btn move-up" data-index="${index}" ${index === 0 ? 'disabled' : ''} style="padding: 0.25rem 0.5rem; margin-left: 0.25rem; border: 1px solid var(--card-outline); border-radius: 4px; background: var(--card-bg); cursor: pointer;">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                            <button class="block-btn move-down" data-index="${index}" ${index === currentExamBlocks.length - 1 ? 'disabled' : ''} style="padding: 0.25rem 0.5rem; margin-left: 0.25rem; border: 1px solid var(--card-outline); border-radius: 4px; background: var(--card-bg); cursor: pointer;">
                                <i class="fas fa-arrow-down"></i>
                            </button>
                            <button class="block-btn delete" data-index="${index}" style="padding: 0.25rem 0.5rem; margin-left: 0.25rem; border: 1px solid #ef4444; border-radius: 4px; background: #fef2f2; color: #ef4444; cursor: pointer;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="block-content">
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label class="block-label">Tiêu đề:</label>
                            <input type="text" class="block-title" data-index="${index}" value="${block.title || ''}" placeholder="Nhập tiêu đề..." style="width: 100%; padding: 0.5rem; border: 1px solid var(--card-outline); border-radius: 4px;">
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label class="block-label">Nội dung:</label>
                            <div class="rich-text-editor" id="editor-${index}"></div>
                            <textarea style="display: none;" id="editor-text-${index}">${content}</textarea>
                        </div>
                        
                        ${block.type === 'question' ? `
                        <div class="block-controls">
                            <div class="form-group">
                                <label class="block-label">Điểm số:</label>
                                <input type="number" class="block-points-input" data-index="${index}" value="${block.points || 1.0}" min="0" max="10" step="0.5" style="width: 100px; padding: 0.5rem; border: 1px solid var(--card-outline); border-radius: 4px;">
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function initRichTextEditors() {
            richTextEditors = [];
            
            currentExamBlocks.forEach((block, index) => {
                const editorId = `editor-${index}`;
                const textareaId = `editor-text-${index}`;
                
                const quill = new Quill(`#${editorId}`, {
                    theme: 'snow',
                    modules: {
                        toolbar: [
                            ['bold', 'italic', 'underline'],
                            [{ 'header': 1 }, { 'header': 2 }],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            ['clean']
                        ]
                    },
                    placeholder: 'Nhập nội dung...'
                });
                
                const textarea = document.getElementById(textareaId);
                if (textarea) {
                    quill.root.innerHTML = markdownToHtml(textarea.value);
                }
                
                richTextEditors[index] = {
                    quill: quill,
                    textareaId: textareaId
                };
            });
        }

        function initAutoUpdate() {
            // Thêm sự kiện cho tất cả các input
            document.querySelectorAll('.block-title, .block-points-input, .block-type-select').forEach(input => {
                input.addEventListener('input', updateEditorPreview);
                input.addEventListener('change', updateEditorPreview);
            });
            
            // Thêm sự kiện cho các quill editor
            richTextEditors.forEach(editor => {
                if (editor.quill) {
                    editor.quill.on('text-change', updateEditorPreview);
                }
            });
            
            // Cập nhật preview ngay lần đầu
            updateEditorPreview();
        }

        function updateEditorPreview() {
            // Lưu tạm thời các thay đổi
            const blocksContainer = document.getElementById('examBlocksContainer');
            if (!blocksContainer) return;
            
            const blockElements = blocksContainer.querySelectorAll('.exam-block-editor');
            const updatedBlocks = [];
            
            const blockArray = Array.from(blockElements);
            
            blockArray.forEach((blockElement, blockIndex) => {
                const dataIndex = parseInt(blockElement.dataset.index);
                const typeSelect = blockElement.querySelector('.block-type-select');
                const titleInput = blockElement.querySelector('.block-title');
                const pointsInput = blockElement.querySelector('.block-points-input');
                
                let content = '';
                if (richTextEditors[dataIndex]) {
                    const quill = richTextEditors[dataIndex].quill;
                    content = quill.root.innerHTML;
                } else {
                    const textarea = document.getElementById(`editor-text-${dataIndex}`);
                    content = textarea ? textarea.value : '';
                }
                
                const blockData = {
                    type: typeSelect.value,
                    title: titleInput.value,
                    content: content,
                    points: typeSelect.value === 'question' ? parseFloat(pointsInput?.value || 1.0) : 0
                };
                
                updatedBlocks.push(blockData);
            });
            
            // Hiển thị preview
            const previewContent = document.getElementById('editorPreviewContent');
            
            if (previewContent) {
                let previewHTML = '';
                let questionCounter = 1;
                
                updatedBlocks.forEach((block, index) => {
                    if (block.type === 'text') {
                        previewHTML += `
                            <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(0,0,0,0.02); border-radius: 4px; border-left: 3px solid var(--primary-color);">
                                <h5 style="margin: 0 0 0.5rem 0; color: var(--primary-color);">${block.title || 'Phần văn bản'}</h5>
                                <div style="white-space: pre-wrap; font-family: 'Times New Roman', Times, serif;">${markdownToHtml(block.content)}</div>
                            </div>
                        `;
                    } else if (block.type === 'question') {
                        previewHTML += `
                            <div style="margin-bottom: 1rem; padding: 1rem; border: 1px solid var(--card-outline); border-radius: 4px;">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                                    <div style="flex: 1;"><strong>Câu ${questionCounter}:</strong> ${markdownToHtml(block.content)}</div>
                                    <div style="background: var(--primary-color); color: white; padding: 0.1rem 0.5rem; border-radius: 10px; font-size: 0.8rem; flex-shrink: 0;">${block.points || 1.0} điểm</div>
                                </div>
                                <div style="min-height: 40px; border: 1px dashed #ccc; padding: 0.5rem; font-size: 0.9rem; color: #666; background: rgba(0,0,0,0.02);">
                                    [Khu vực trả lời của thí sinh]
                                </div>
                            </div>
                        `;
                        questionCounter++;
                    }
                });
                
                if (previewHTML === '') {
                    previewHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 1rem;">Chưa có nội dung để hiển thị</p>';
                }
                
                previewContent.innerHTML = previewHTML;
            }
            
            // Lưu các thay đổi vào currentExamBlocks
            currentExamBlocks = updatedBlocks;
        }

        function updateExamFromEditor() {
            updateEditorPreview(); // Gọi hàm này để cập nhật currentExamBlocks
        }

        function reorderBlocks() {
            updateExamFromEditor();
            
            const modal = document.getElementById('editExamModal');
            modal.classList.remove('active');
            
            setTimeout(() => {
                openExamEditor();
            }, 300);
        }

        function addBlock(type) {
            const newBlock = {
                type: type,
                title: type === 'text' ? 'Phần mới' : 'Câu hỏi mới',
                content: '',
                points: type === 'question' ? 1.0 : 0
            };
            
            currentExamBlocks.push(newBlock);
            
            const blocksContainer = document.getElementById('examBlocksContainer');
            blocksContainer.insertAdjacentHTML('beforeend', createBlockEditorHTML(newBlock, currentExamBlocks.length - 1));
            
            // Khởi tạo editor mới
            const newIndex = currentExamBlocks.length - 1;
            const editorId = `editor-${newIndex}`;
            const textareaId = `editor-text-${newIndex}`;
            
            const quill = new Quill(`#${editorId}`, {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'header': 1 }, { 'header': 2 }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['clean']
                    ]
                },
                placeholder: 'Nhập nội dung...'
            });
            
            richTextEditors[newIndex] = {
                quill: quill,
                textareaId: textareaId
            };
            
            // Thêm sự kiện cho editor mới
            quill.on('text-change', updateEditorPreview);
            
            // Thêm sự kiện cho các input mới
            const blockElement = document.querySelector(`[data-index="${newIndex}"]`);
            if (blockElement) {
                blockElement.querySelector('.block-title').addEventListener('input', updateEditorPreview);
                blockElement.querySelector('.block-type-select').addEventListener('change', updateEditorPreview);
                const pointsInput = blockElement.querySelector('.block-points-input');
                if (pointsInput) {
                    pointsInput.addEventListener('input', updateEditorPreview);
                }
            }
            
            // Cập nhật preview
            updateEditorPreview();
        }

        function deleteBlock(index) {
            if (currentExamBlocks.length <= 1) {
                alert('Cần ít nhất một khối nội dung!');
                return;
            }
            
            currentExamBlocks.splice(index, 1);
            richTextEditors.splice(index, 1);
            
            // Tạo lại giao diện
            const editorContainer = document.getElementById('examEditorContainer');
            editorContainer.innerHTML = createExamEditorHTML();
            
            setTimeout(() => {
                initRichTextEditors();
                initAutoUpdate();
            }, 100);
        }

        function moveBlock(index, direction) {
            if (direction === 'up' && index > 0) {
                // Hoán đổi vị trí trong mảng
                [currentExamBlocks[index], currentExamBlocks[index - 1]] = [currentExamBlocks[index - 1], currentExamBlocks[index]];
                [richTextEditors[index], richTextEditors[index - 1]] = [richTextEditors[index - 1], richTextEditors[index]];
            } else if (direction === 'down' && index < currentExamBlocks.length - 1) {
                [currentExamBlocks[index], currentExamBlocks[index + 1]] = [currentExamBlocks[index + 1], currentExamBlocks[index]];
                [richTextEditors[index], richTextEditors[index + 1]] = [richTextEditors[index + 1], richTextEditors[index]];
            }
            
            // Tạo lại giao diện
            const editorContainer = document.getElementById('examEditorContainer');
            editorContainer.innerHTML = createExamEditorHTML();
            
            setTimeout(() => {
                initRichTextEditors();
                initAutoUpdate();
            }, 100);
        }

        function saveEditedExam() {
            updateExamFromEditor();
            
            const modal = document.getElementById('editExamModal');
            modal.classList.remove('active');
            
            const examData = {
                title: "Đề thi Ngữ Văn",
                description: "Đề thi đã được chỉnh sửa",
                workInfo: currentRealWorkInfo,
                blocks: currentExamBlocks
            };
            
            const examNotes = document.getElementById('examNotes').value;
            showExamResult(examData, examNotes);
        }

        function updateExamPreview() {
            updateExamFromEditor();
            
            let previewHTML = `
                <div class="preview-exam">
                    <h1 class="exam-title">ĐỀ THI NGỮ VĂN</h1>
                    <div class="exam-info">
                        <p><strong>Thời gian làm bài:</strong> ${examSettings.time} phút | <strong>Mã đề:</strong> ${currentExamCode}</p>
                        <p><strong>Khối lớp:</strong> ${examSettings.grade} | <strong>Độ khó:</strong> ${examSettings.difficulty === 'easy' ? 'Dễ' : examSettings.difficulty === 'medium' ? 'Trung bình' : 'Khó'}</p>
                    </div>
            `;
            
            if (currentRealWorkInfo) {
                previewHTML += `
                    <div class="exam-info" style="background: rgba(76, 175, 80, 0.1); border-color: #4CAF50;">
                        <p><strong>Tác phẩm:</strong> ${currentRealWorkInfo.title} | <strong>Tác giả:</strong> ${currentRealWorkInfo.author} | <strong>Thể loại:</strong> ${currentRealWorkInfo.genre}</p>
                    </div>
                `;
            }
            
            let questionCounter = 1;
            let totalPoints = 0;
            
            currentExamBlocks.forEach((block, index) => {
                if (block.type === 'text') {
                    previewHTML += `
                        <div class="exam-section">
                            <h3 class="section-title">${block.title || 'Phần văn bản'}</h3>
                            <div class="text-content markdown-content" style="white-space: pre-wrap; font-family: 'Times New Roman', Times, serif;">${markdownToHtml(block.content)}</div>
                        </div>
                    `;
                } else if (block.type === 'question') {
                    totalPoints += block.points || 0;
                    previewHTML += `
                        <div class="question-item">
                            <div class="question-header">
                                <div class="question-text markdown-content"><strong>Câu ${questionCounter}:</strong> ${markdownToHtml(block.content)}</div>
                                <div class="question-points">${block.points || 1.0} điểm</div>
                            </div>
                            <div class="answer-area">
                                <textarea class="answer-textarea" placeholder="Thí sinh viết câu trả lời vào đây..." rows="4" style="white-space: pre-wrap;"></textarea>
                            </div>
                        </div>
                    `;
                    questionCounter++;
                }
            });
            
            previewHTML += `
                <div class="exam-info" style="margin-top: 2rem; padding-top: 1rem; border-top: 2px solid var(--card-outline);">
                    <p><strong>Tổng điểm: ${totalPoints.toFixed(1)} điểm</strong></p>
                    <p><em>--- Hết đề thi ---</em></p>
                </div>
            `;
            
            previewHTML += `</div>`;
            document.getElementById('previewContent').innerHTML = previewHTML;
            
            const modal = document.getElementById('previewModal');
            modal.classList.add('active');
        }

        function saveExam() {
            const editModal = document.getElementById('editExamModal');
            if (editModal && editModal.classList.contains('active')) {
                updateExamFromEditor();
            }
            
            const examData = {
                code: currentExamCode,
                title: "Đề thi Ngữ Văn",
                time: examSettings.time,
                difficulty: examSettings.difficulty,
                grade: examSettings.grade,
                blocks: currentExamBlocks.map(block => ({
                    ...block,
                    content: processContentForStorage(block.content)
                })),
                isRealWork: !!currentRealWorkInfo,
                workInfo: currentRealWorkInfo,
                createdAt: new Date().toISOString(),
                totalPoints: currentExamBlocks.reduce((sum, block) => sum + (block.points || 0), 0),
                apiUsed: API_ENDPOINTS[activeApiIndex]?.name || 'Unknown'
            };
            
            const savedExams = JSON.parse(localStorage.getItem('vanw_exams') || '[]');
            savedExams.push(examData);
            localStorage.setItem('vanw_exams', JSON.stringify(savedExams));
        }

        function printExam() {
            updateExamFromEditor();
            
            let printHTML = `
                <div class="preview-exam">
                    <h1 class="exam-title">ĐỀ THI NGỮ VĂN</h1>
                    <div class="exam-info">
                        <p><strong>Thời gian làm bài:</strong> ${examSettings.time} phút | <strong>Mã đề:</strong> ${currentExamCode}</p>
                        <p><strong>Khối lớp:</strong> ${examSettings.grade} | <strong>Độ khó:</strong> ${examSettings.difficulty === 'easy' ? 'Dễ' : examSettings.difficulty === 'medium' ? 'Trung bình' : 'Khó'}</p>
                    </div>
            `;
            
            if (currentRealWorkInfo) {
                printHTML += `
                    <div class="exam-info" style="background: rgba(76, 175, 80, 0.1); border-color: #4CAF50;">
                        <p><strong>Tác phẩm:</strong> ${currentRealWorkInfo.title} | <strong>Tác giả:</strong> ${currentRealWorkInfo.author} | <strong>Thể loại:</strong> ${currentRealWorkInfo.genre}</p>
                    </div>
                `;
            }
            
            let questionCounter = 1;
            let totalPoints = 0;
            
            currentExamBlocks.forEach((block, index) => {
                if (block.type === 'text') {
                    printHTML += `
                        <div class="exam-section">
                            <h3 class="section-title">${block.title || 'Phần văn bản'}</h3>
                            <div class="text-content markdown-content" style="white-space: pre-wrap; font-family: 'Times New Roman', Times, serif;">${markdownToHtml(block.content)}</div>
                        </div>
                    `;
                } else if (block.type === 'question') {
                    totalPoints += block.points || 0;
                    printHTML += `
                        <div class="question-item">
                            <div class="question-header">
                                <div class="question-text markdown-content"><strong>Câu ${questionCounter}:</strong> ${markdownToHtml(block.content)}</div>
                                <div class="question-points">${block.points || 1.0} điểm</div>
                            </div>
                            <div class="answer-area">
                                <div class="answer-space" style="min-height: 100px; border: 1px dashed #ccc; margin-top: 10px; padding: 10px;"></div>
                            </div>
                        </div>
                    `;
                    questionCounter++;
                }
            });
            
            printHTML += `
                <div class="exam-info" style="margin-top: 2rem; padding-top: 1rem; border-top: 2px solid var(--card-outline);">
                    <p><strong>Tổng điểm: ${totalPoints.toFixed(1)} điểm</strong></p>
                    <p><em>--- Hết đề thi ---</em></p>
                </div>
            `;
            
            printHTML += `</div>`;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Đề thi ${currentExamCode} - VANW</title>
                    <style>
                        body { 
                            font-family: 'Times New Roman', Times, serif; 
                            padding: 20px; 
                            line-height: 1.6;
                            color: #333;
                            max-width: 210mm;
                            margin: 0 auto;
                        }
                        .exam-title { 
                            text-align: center; 
                            color: #e37c2d;
                            font-size: 24px;
                            margin-bottom: 10px;
                            border-bottom: 3px solid #e37c2d;
                            padding-bottom: 10px;
                        }
                        .exam-info { 
                            text-align: center; 
                            color: #666;
                            margin-bottom: 30px;
                            font-size: 14px;
                        }
                        .section-title {
                            color: #e37c2d;
                            font-size: 18px;
                            margin: 25px 0 15px;
                            padding-bottom: 5px;
                            border-bottom: 2px solid rgba(227, 124, 45, 0.3);
                        }
                        .text-content {
                            background: #f9f9f9;
                            padding: 15px;
                            border-radius: 8px;
                            margin-bottom: 20px;
                            border-left: 4px solid #e37c2d;
                            white-space: pre-wrap;
                            font-family: 'Times New Roman', Times, serif;
                        }
                        .question-item {
                            margin-bottom: 20px;
                            padding: 15px;
                            border: 1px solid #ddd;
                            border-radius: 8px;
                        }
                        .question-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: flex-start;
                            margin-bottom: 10px;
                        }
                        .question-text {
                            flex: 1;
                            font-weight: 500;
                        }
                        .question-points {
                            background: #e37c2d;
                            color: white;
                            padding: 2px 10px;
                            border-radius: 15px;
                            font-size: 12px;
                            font-weight: bold;
                        }
                        .answer-space {
                            min-height: 100px;
                            border: 1px dashed #ccc;
                            padding: 10px;
                            border-radius: 5px;
                            margin-top: 10px;
                        }
                        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
                            color: #e37c2d;
                        }
                        .markdown-content strong {
                            color: #e37c2d;
                            font-weight: bold;
                        }
                        .markdown-content em {
                            font-style: italic;
                        }
                        .markdown-content u {
                            text-decoration: underline;
                        }
                        @media print {
                            body { font-size: 12pt; }
                            .no-print { display: none; }
                            .exam-title { font-size: 20pt; }
                            .text-content { font-family: 'Times New Roman', Times, serif !important; }
                        }
                    </style>
                </head>
                <body>
                    ${printHTML}
                    <div class="exam-info no-print" style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ccc; font-size: 12px; color: #888;">
                        <p>Được tạo bởi Hệ thống Tạo Bài Thi Văn Học VANW</p>
                        <p>Ngày in: ${new Date().toLocaleDateString('vi-VN')}</p>
                    </div>
                    <script>
                        window.onload = function() { 
                            setTimeout(() => { window.print(); }, 500);
                        }
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function addBlockyBlock(type) {
            const blockId = Date.now();
            const block = {
                id: blockId,
                type: type,
                title: type === 'text' ? 'Phần văn bản' : 'Câu hỏi',
                content: '',
                points: type === 'question' ? 1.0 : 0
            };
            
            blockyBlocks.push(block);
            renderBlockyBlocks();
        }

        function removeBlockyBlock(blockId) {
            blockyBlocks = blockyBlocks.filter(block => block.id !== blockId);
            blockyEditors = blockyEditors.filter(editor => editor.blockId !== blockId);
            renderBlockyBlocks();
        }

        function updateBlockyBlock(blockId, field, value) {
            const block = blockyBlocks.find(b => b.id === blockId);
            if (block) {
                block[field] = value;
            }
        }

        function moveBlockyBlock(blockId, direction) {
            const index = blockyBlocks.findIndex(b => b.id === blockId);
            if (index === -1) return;
            
            if (direction === 'up' && index > 0) {
                [blockyBlocks[index], blockyBlocks[index - 1]] = [blockyBlocks[index - 1], blockyBlocks[index]];
            } else if (direction === 'down' && index < blockyBlocks.length - 1) {
                [blockyBlocks[index], blockyBlocks[index + 1]] = [blockyBlocks[index + 1], blockyBlocks[index]];
            }
            
            renderBlockyBlocks();
        }

        function initBlockyEditor(blockId) {
            const editorContainer = document.querySelector(`[data-block-id="${blockId}"] .blocky-rich-editor`);
            if (!editorContainer) return;
            
            // Xóa editor cũ nếu tồn tại
            const existingEditor = blockyEditors.find(editor => editor.blockId === blockId);
            if (existingEditor && existingEditor.quill) {
                existingEditor.quill.root.innerHTML = '';
            }
            
            // Tạo editor mới với chỉ MỘT toolbar
            const quill = new Quill(editorContainer, {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'header': 1 }, { 'header': 2 }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['clean']
                    ]
                },
                placeholder: 'Nhập nội dung...'
            });
            
            const block = blockyBlocks.find(b => b.id === blockId);
            if (block && block.content) {
                quill.root.innerHTML = markdownToHtml(displayContentWithLineBreaks(block.content));
            }
            
            quill.on('text-change', function() {
                updateBlockyBlock(blockId, 'content', quill.root.innerHTML);
            });
            
            const editorIndex = blockyEditors.findIndex(editor => editor.blockId === blockId);
            if (editorIndex > -1) {
                blockyEditors[editorIndex] = { blockId, quill };
            } else {
                blockyEditors.push({ blockId, quill });
            }
        }

        function renderBlockyBlocks() {
            const previewContainer = document.getElementById('blockyPreview');
            
            if (blockyBlocks.length === 0) {
                previewContainer.innerHTML = `
                    <div class="blocky-empty-state">
                        <i class="fas fa-cubes"></i>
                        <h4>Chưa có nội dung</h4>
                        <p>Bấm vào nút "Thêm văn bản" hoặc "Thêm câu hỏi" để bắt đầu tạo đề thi</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            blockyBlocks.forEach((block, index) => {
                html += `
                    <div class="blocky-block" data-block-id="${block.id}">
                        <div class="blocky-block-header">
                            <div class="blocky-block-title">
                                <i class="fas fa-${block.type === 'text' ? 'paragraph' : 'question-circle'}"></i>
                                ${block.title || (block.type === 'text' ? 'Phần văn bản' : 'Câu hỏi')}
                            </div>
                            <div class="blocky-block-controls">
                                <button class="blocky-block-btn move-up" onclick="moveBlockyBlock(${block.id}, 'up')" ${index === 0 ? 'disabled' : ''}>
                                    <i class="fas fa-arrow-up"></i>
                                </button>
                                <button class="blocky-block-btn move-down" onclick="moveBlockyBlock(${block.id}, 'down')" ${index === blockyBlocks.length - 1 ? 'disabled' : ''}>
                                    <i class="fas fa-arrow-down"></i>
                                </button>
                                <button class="blocky-block-btn delete" onclick="removeBlockyBlock(${block.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="blocky-block-content">
                            <div class="form-group" style="margin-bottom: 0.5rem;">
                                <input type="text" 
                                       value="${block.title || ''}" 
                                       placeholder="Nhập tiêu đề..." 
                                       oninput="updateBlockyBlock(${block.id}, 'title', this.value)"
                                       style="width: 100%; padding: 0.5rem; border: 1px solid var(--card-outline); border-radius: 4px;">
                            </div>
                            <div class="blocky-rich-editor" id="blocky-editor-${block.id}"></div>
                `;
                
                if (block.type === 'question') {
                    html += `
                            <div class="blocky-block-footer">
                                <div class="form-group" style="margin-top: 1rem;">
                                    <label style="font-size: 0.9rem; color: var(--text-secondary); margin-right: 0.5rem;">Điểm:</label>
                                    <input type="number" 
                                           value="${block.points || 1.0}" 
                                           min="0" 
                                           max="10" 
                                           step="0.5"
                                           oninput="updateBlockyBlock(${block.id}, 'points', parseFloat(this.value))"
                                           style="width: 80px; padding: 0.25rem 0.5rem; border: 1px solid var(--card-outline); border-radius: 4px;">
                                </div>
                            </div>
                    `;
                }
                
                html += `</div></div>`;
            });
            
            previewContainer.innerHTML = html;
            
            // Khởi tạo editors
            setTimeout(() => {
                blockyBlocks.forEach(block => {
                    initBlockyEditor(block.id);
                });
            }, 100);
        }

        function clearBlockyBlocks() {
            if (blockyBlocks.length === 0) return;
            
            if (confirm('Bạn có chắc chắn muốn xóa tất cả các khối?')) {
                blockyBlocks = [];
                blockyEditors = [];
                renderBlockyBlocks();
            }
        }

        function showNotification(message, type = 'info') {
            const oldNotification = document.querySelector('.notification');
            if (oldNotification) {
                oldNotification.remove();
            }
            
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            
            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            if (type === 'error') icon = 'exclamation-circle';
            if (type === 'warning') icon = 'exclamation-triangle';
            
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas fa-${icon}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            notification.style.cssText = `
                position: fixed;
                top: 30px;
                right: 30px;
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : type === 'warning' ? '#ff9800' : '#2196F3'};
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 6px 20px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: slideIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55), fadeOut 0.4s ease 3.6s;
                animation-fill-mode: forwards;
                max-width: 400px;
                border: 2px solid rgba(255,255,255,0.3);
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 4000);
        }

        function setupExamSlider() {
            const slider = document.getElementById('examTimeSlider');
            const valueDisplay = document.getElementById('examTimeValue');
            
            if (!slider || !valueDisplay) return;
            
            valueDisplay.textContent = formatDuration(slider.value);
            updateExamSliderColor(slider.value);
            
            slider.addEventListener('input', function() {
                valueDisplay.textContent = formatDuration(this.value);
                updateExamSliderColor(this.value);
                
                const durationBtns = document.querySelectorAll('.duration-btn');
                durationBtns.forEach(btn => {
                    if (parseInt(btn.dataset.value) === parseInt(this.value)) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            });
            
            const durationBtns = document.querySelectorAll('.duration-btn');
            durationBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const value = parseInt(this.dataset.value);
                    slider.value = value;
                    valueDisplay.textContent = formatDuration(value);
                    updateExamSliderColor(value);
                    
                    durationBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }

        function updateExamSliderColor(value) {
            const slider = document.getElementById('examTimeSlider');
            const percent = ((value - slider.min) / (slider.max - slider.min)) * 100;
            slider.style.background = `linear-gradient(to right, var(--primary-color) 0%, var(--primary-color) ${percent}%, var(--border-color) ${percent}%, var(--border-color) 100%)`;
        }

        function setupWordCounter() {
            const textarea = document.getElementById('inputText');
            const wordCount = document.getElementById('wordCount');
            
            if (!textarea || !wordCount) return;
            
            textarea.addEventListener('input', function() {
                const count = countWords(this.value);
                wordCount.textContent = `${count} từ`;
                
                if (count < 20) {
                    wordCount.style.color = '#ef4444';
                    wordCount.style.fontWeight = '600';
                } else {
                    wordCount.style.color = 'var(--text-secondary)';
                    wordCount.style.fontWeight = 'normal';
                }
            });
        }

        function setupModal() {
            const previewModal = document.getElementById('previewModal');
            const editModal = document.getElementById('editExamModal');
            const closeButtons = document.querySelectorAll('.close-modal');
            const closePreviewBtn = document.getElementById('closePreviewBtn');
            const printPreviewBtn = document.getElementById('printPreviewBtn');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            
            closeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    if (modal) {
                        modal.classList.remove('active');
                    }
                });
            });
            
            if (closePreviewBtn) {
                closePreviewBtn.addEventListener('click', function() {
                    previewModal.classList.remove('active');
                });
            }
            
            if (cancelEditBtn) {
                cancelEditBtn.addEventListener('click', function() {
                    editModal.classList.remove('active');
                });
            }
            
            if (printPreviewBtn) {
                printPreviewBtn.addEventListener('click', function() {
                    const printContent = document.getElementById('previewContent').innerHTML;
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>Đề thi ${currentExamCode} - VANW</title>
                            <style>
                                body { 
                                    font-family: 'Times New Roman', Times, serif; 
                                    padding: 20px; 
                                    line-height: 1.6;
                                    color: #333;
                                    max-width: 210mm;
                                    margin: 0 auto;
                                }
                                .exam-title { 
                                    text-align: center; 
                                    color: #e37c2d;
                                    font-size: 24px;
                                    margin-bottom: 10px;
                                    border-bottom: 3px solid #e37c2d;
                                    padding-bottom: 10px;
                                }
                                .exam-info { 
                                    text-align: center; 
                                    color: #666;
                                    margin-bottom: 30px;
                                    font-size: 14px;
                                }
                                .section-title {
                                    color: #e37c2d;
                                    font-size: 18px;
                                    margin: 25px 0 15px;
                                    padding-bottom: 5px;
                                    border-bottom: 2px solid rgba(227, 124, 45, 0.3);
                                }
                                .text-content {
                                    background: #f9f9f9;
                                    padding: 15px;
                                    border-radius: 8px;
                                    margin-bottom: 20px;
                                    border-left: 4px solid #e37c2d;
                                    white-space: pre-wrap;
                                    font-family: 'Times New Roman', Times, serif;
                                }
                                .question-item {
                                    margin-bottom: 20px;
                                    padding: 15px;
                                    border: 1px solid #ddd;
                                    border-radius: 8px;
                                }
                                .question-header {
                                    display: flex;
                                    justify-content: space-between;
                                    align-items: flex-start;
                                    margin-bottom: 10px;
                                }
                                .question-text {
                                    flex: 1;
                                    font-weight: 500;
                                }
                                .question-points {
                                    background: #e37c2d;
                                    color: white;
                                    padding: 2px 10px;
                                    border-radius: 15px;
                                    font-size: 12px;
                                    font-weight: bold;
                                }
                                .answer-textarea {
                                    width: 100%;
                                    min-height: 100px;
                                    border: 1px dashed #ccc;
                                    padding: 10px;
                                    border-radius: 5px;
                                    margin-top: 10px;
                                    font-family: inherit;
                                }
                                .markdown-content h1, .markdown-content h2, .markdown-content h3 {
                                    color: #e37c2d;
                                }
                                .markdown-content strong {
                                    color: #e37c2d;
                                    font-weight: bold;
                                }
                                .markdown-content em {
                                    font-style: italic;
                                }
                                .markdown-content u {
                                    text-decoration: underline;
                                }
                                @media print {
                                    body { font-size: 12pt; }
                                    .no-print { display: none; }
                                    .exam-title { font-size: 20pt; }
                                    .text-content { font-family: 'Times New Roman', Times, serif !important; }
                                }
                            </style>
                        </head>
                <body>
                    ${printContent}
                    <div class="exam-info no-print" style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ccc; font-size: 12px; color: #888;">
                        <p>Được tạo bởi Hệ thống Tạo Bài Thi Văn Học VANW</p>
                        <p>Ngày in: ${new Date().toLocaleDateString('vi-VN')}</p>
                    </div>
                    <script>
                        window.onload = function() { 
                            setTimeout(() => { window.print(); }, 500);
                        }
                    <\/script>
                </body>
                </html>
            `);
                    printWindow.document.close();
                });
            }
            
            [previewModal, editModal].forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });
            
            document.addEventListener('click', function(e) {
                if (e.target && e.target.id === 'addTextBlockBtn') {
                    e.preventDefault();
                    if (currentCreationMode === 'blocky') {
                        addBlockyBlock('text');
                    } else {
                        addBlock('text');
                    }
                }
                
                if (e.target && e.target.id === 'addQuestionBlockBtn') {
                    e.preventDefault();
                    if (currentCreationMode === 'blocky') {
                        addBlockyBlock('question');
                    } else {
                        addBlock('question');
                    }
                }
                
                if (e.target && e.target.id === 'reorderBlocksBtn') {
                    e.preventDefault();
                    reorderBlocks();
                }
                
                if (e.target && e.target.closest('.block-btn.delete')) {
                    e.preventDefault();
                    const btn = e.target.closest('.block-btn.delete');
                    const index = parseInt(btn.dataset.index);
                    deleteBlock(index);
                }
                
                if (e.target && e.target.closest('.block-btn.move-up')) {
                    e.preventDefault();
                    const btn = e.target.closest('.block-btn.move-up');
                    const index = parseInt(btn.dataset.index);
                    moveBlock(index, 'up');
                }
                
                if (e.target && e.target.closest('.block-btn.move-down')) {
                    e.preventDefault();
                    const btn = e.target.closest('.block-btn.move-down');
                    const index = parseInt(btn.dataset.index);
                    moveBlock(index, 'down');
                }
                
                if (e.target && e.target.id === 'clearBlocksBtn') {
                    e.preventDefault();
                    clearBlockyBlocks();
                }
                
                if (e.target && e.target.id === 'saveEditedExamBtn') {
                    e.preventDefault();
                    saveEditedExam();
                }
            });
        }

        function switchCreationMode(mode) {
            currentCreationMode = mode;
            
            document.querySelectorAll('.mode-tab').forEach(tab => {
                if (tab.dataset.mode === mode) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            document.querySelectorAll('.mode-content').forEach(content => {
                if (content.id === `mode-${mode}`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
            
            const actionButtonsContainer = document.getElementById('actionButtonsContainer');
            const generateBtn = document.getElementById('generateExamBtn');
            const randomBtn = document.getElementById('generateRandomExamBtn');
            const settingsBtn = document.getElementById('settingsBtn');
            
            if (mode === 'text') {
                actionButtonsContainer.className = 'action-buttons text-mode';
                actionButtonsContainer.innerHTML = `
                    <div class="left-buttons">
                        <button id="generateExamBtn" class="generate-btn">
                            <i class="fas fa-file-alt mr-2"></i> Tạo Đề Thi
                        </button>
                        <button id="generateRandomExamBtn" class="random-btn">
                            <i class="fas fa-dice mr-2"></i> Đề Thi Ngẫu Nhiên
                        </button>
                    </div>
                    <div class="right-buttons">
                        <button id="settingsBtn" class="settings-btn">
                            <i class="fas fa-cog mr-2"></i> Cài đặt
                        </button>
                    </div>
                `;
                
                document.getElementById('generateExamBtn').addEventListener('click', generateExam);
                document.getElementById('generateRandomExamBtn').addEventListener('click', generateRandomExam);
                document.getElementById('settingsBtn').addEventListener('click', toggleSettingsPanel);
                
            } else if (mode === 'ai') {
                actionButtonsContainer.className = 'action-buttons ai-mode';
                actionButtonsContainer.innerHTML = `
                    <div class="left-buttons">
                        <button id="generateExamBtn" class="generate-btn" style="flex: 2;">
                            <i class="fas fa-robot mr-2"></i> Tạo Đề Thi Bằng AI
                        </button>
                        <button id="settingsBtn" class="settings-btn" style="flex: 1;">
                            <i class="fas fa-cog mr-2"></i> Cài đặt
                        </button>
                    </div>
                `;
                
                document.getElementById('generateExamBtn').addEventListener('click', generateExam);
                document.getElementById('settingsBtn').addEventListener('click', toggleSettingsPanel);
                
            } else if (mode === 'blocky') {
                actionButtonsContainer.className = 'action-buttons blocky-mode';
                actionButtonsContainer.innerHTML = `
                    <div class="left-buttons">
                        <button id="generateExamBtn" class="generate-btn" style="flex: 2;">
                            <i class="fas fa-cubes mr-2"></i> Tạo Đề Thi Blocky
                        </button>
                        <button id="settingsBtn" class="settings-btn" style="flex: 1;">
                            <i class="fas fa-cog mr-2"></i> Cài đặt
                        </button>
                    </div>
                `;
                
                document.getElementById('generateExamBtn').addEventListener('click', generateExam);
                document.getElementById('settingsBtn').addEventListener('click', toggleSettingsPanel);
            }
            
            const modeNames = {
                'text': 'Tạo theo văn bản',
                'ai': 'Tạo bằng AI',
                'blocky': 'Tạo Blocky'
            };
        }

        function toggleSettingsPanel() {
            const settingsPanel = document.getElementById('settingsPanel');
            if (settingsPanel) {
                settingsPanel.classList.toggle('active');
                
                const icon = this.querySelector('i');
                if (settingsPanel.classList.contains('active')) {
                    icon.className = 'fas fa-times mr-2';
                    this.style.backgroundColor = 'rgba(227, 124, 45, 0.2)';
                    this.style.borderColor = 'var(--primary-color)';
                } else {
                    icon.className = 'fas fa-cog mr-2';
                    this.style.backgroundColor = '';
                    this.style.borderColor = '';
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.mode-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const mode = this.dataset.mode;
                    switchCreationMode(mode);
                });
            });
            
            window.addBlockyBlock = addBlockyBlock;
            window.removeBlockyBlock = removeBlockyBlock;
            window.updateBlockyBlock = updateBlockyBlock;
            window.moveBlockyBlock = moveBlockyBlock;
            window.clearBlockyBlocks = clearBlockyBlocks;
            
            const generateExamBtn = document.getElementById('generateExamBtn');
            if (generateExamBtn) {
                generateExamBtn.addEventListener('click', generateExam);
            }
            
            const generateRandomExamBtn = document.getElementById('generateRandomExamBtn');
            if (generateRandomExamBtn) {
                generateRandomExamBtn.addEventListener('click', generateRandomExam);
            }
            
            const settingsBtn = document.getElementById('settingsBtn');
            if (settingsBtn) {
                settingsBtn.addEventListener('click', toggleSettingsPanel);
            }
            
            const inputText = document.getElementById('inputText');
            if (inputText) {
                inputText.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        e.preventDefault();
                        generateExam();
                    }
                });
            }
            
            const aiPrompt = document.getElementById('aiPrompt');
            if (aiPrompt) {
                aiPrompt.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        e.preventDefault();
                        generateExam();
                    }
                });
            }
            
            setupExamSlider();
            setupWordCounter();
            setupModal();
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(100%) translateY(-20px);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0) translateY(0);
                        opacity: 1;
                    }
                }
                
                @keyframes fadeOut {
                    from {
                        opacity: 1;
                    }
                    to {
                        opacity: 0;
                        transform: translateX(100%) translateY(-20px);
                    }
                }
                
                .notification-content {
                    display: flex;
                    align-items: center;
                    gap: 12px;
                }
                
                .notification-content i {
                    font-size: 1.3rem;
                }
                
                .notification-content span {
                    font-size: 1rem;
                    font-weight: 500;
                }
                
                #editExamModal .modal-footer {
                    display: none;
                }
            `;
            document.head.appendChild(style);
            
            document.getElementById('inputText')?.focus();
            
            renderBlockyBlocks();
            
            // Log API status khi khởi động
            console.log('API Status:');
            API_ENDPOINTS.forEach((api, index) => {
                console.log(`${index + 1}. ${api.name}: ${api.active ? 'Active' : 'Inactive'}`);
            });
            console.log(`Active API: ${API_ENDPOINTS[activeApiIndex]?.name || 'None'}`);
        });
    </script>
</body>
</html>
