<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Ph√≤ng Th·ªß - Gemini AI Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#1e40af',
                        dark: {
                            bg: '#0f172a',
                            text: '#e2e8f0',
                            sidebar: '#1e293b',
                            hover: '#334155'
                        }
                    },
                    fontFamily: {
                        sans: ['Calibri', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Calibri', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
        }
        
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .typing-dots::after {
            content: '...';
            animation: typing 1.5s infinite;
        }
        
        @keyframes typing {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }
        
        .user-message {
            align-self: flex-end;
            background-color: #3b82f6;
            border-radius: 1rem;
            max-width: 80%;
            margin-left: auto;
            padding: 0.75rem;
        }
        
        .bot-message {
            align-self: flex-start;
            background-color: #1e293b;
            border-radius: 1rem;
            max-width: 80%;
            margin-right: auto;
            padding: 0.75rem;
        }
        
        .message-content {
            word-wrap: break-word;
            white-space: pre-wrap;
            border-radius: 0.5rem;
            padding: 0.5rem;
        }
        
        .api-status {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .status-active {
            background-color: #10b981;
            color: white;
        }
        
        .status-error {
            background-color: #ef4444;
            color: white;
        }
    </style>
</head>
<body class="h-screen flex flex-col bg-dark-bg text-dark-text">

    <div id="app" class="flex flex-col h-full overflow-hidden">

        <header class="p-4 border-b border-gray-700 bg-dark-bg">
            <h1 class="text-xl font-semibold text-center">API Ph√≤ng Th·ªß - Gemini AI Chatbot</h1>
            <div id="current-api-status" class="api-status status-active mt-2 text-center text-sm">
                <i class="fas fa-check-circle mr-1"></i> ƒêang kh·ªüi t·∫°o h·ªá th·ªëng...
            </div>
        </header>

        <div id="chat-container" class="flex-1 overflow-y-auto hide-scrollbar p-4 bg-gray-900 flex flex-col gap-3">
            <div id="chat-messages" class="flex flex-col gap-3 mx-auto max-w-3xl w-full">
                <div class="bot-message max-w-3xl">
                    <div class="message-content">
                        <p><strong>ü§ñ API Ph√≤ng Th·ªß Chatbot</strong></p>
                        <p>H·ªá th·ªëng ƒëang kh·ªüi t·∫°o v√† ki·ªÉm tra API. Vui l√≤ng ƒë·ª£i...</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="typing-indicator" class="hidden max-w-3xl mx-auto p-4">
            <div class="bot-message">
                <div class="message-content">
                    <span class="typing-dots">AI ƒëang suy nghƒ©</span>
                </div>
            </div>
        </div>

        <div class="p-4 border-t border-gray-700 bg-dark-bg">
            <div class="max-w-3xl mx-auto">
                <form id="chat-form" class="relative">
                    <textarea 
                        id="message-input" 
                        class="w-full p-4 rounded-lg border border-gray-600 bg-dark-hover resize-none focus:outline-none focus:ring-2 focus:ring-primary text-white"
                        placeholder="ƒêang kh·ªüi t·∫°o API... vui l√≤ng ƒë·ª£i"
                        rows="2"
                        disabled
                    ></textarea>
                    <button type="submit" class="absolute right-3 bottom-3 bg-primary hover:bg-primary/90 text-white p-2 rounded-lg">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        // H√†m ƒë·∫£o ng∆∞·ª£c chu·ªói ƒë·ªÉ l·∫•y key ƒë√∫ng
        function reverseApiKey(reversedKey) {
            if (!reversedKey || typeof reversedKey !== 'string') {
                console.error("API key kh√¥ng h·ª£p l·ªá:", reversedKey);
                return reversedKey;
            }
            return reversedKey.split('').reverse().join('');
        }

        class APIDefenseSystem {
            constructor() {
                // API key CH√çNH b·ªã ƒë·∫£o ng∆∞·ª£c trong code
                this.reversedPrimaryApiKey = "cbRSGo7aT22YUIRKGY4db94W_uD1rUmkDySazIA";
                this.primaryModel = "gemini-2.5-flash";
                this.allApis = [];
                this.workingApis = [];
                this.currentApiIndex = -1;
                this.isInitialized = false;
            }

            async initialize() {
                console.log("=== B·∫ÆT ƒê·∫¶U KI·ªÇM TRA T·∫§T C·∫¢ API ===");
                console.log("L∆∞u √Ω: T·∫•t c·∫£ API key ƒë·ªÅu ƒë∆∞·ª£c ƒë·∫£o ng∆∞·ª£c, h·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông ƒë·∫£o l·∫°i");
                
                // Th√™m API ch√≠nh v√†o danh s√°ch (ƒë√£ ƒë·∫£o ng∆∞·ª£c)
                this.allApis.push({
                    reversedKey: this.reversedPrimaryApiKey,
                    apiKey: reverseApiKey(this.reversedPrimaryApiKey), // ƒê·∫£o ng∆∞·ª£c ƒë·ªÉ d√πng
                    model: this.primaryModel,
                    isPrimary: true,
                    index: 0
                });
                
                // Load API d·ª± ph√≤ng t·ª´ file (c≈©ng ƒë√£ ƒë·∫£o ng∆∞·ª£c)
                await this.loadBackupApis();
                
                // Test t·∫•t c·∫£ API
                await this.testAllApisSequentially();
                
                // Ch·ªçn API ho·∫°t ƒë·ªông ƒë·∫ßu ti√™n
                if (this.workingApis.length > 0) {
                    this.currentApiIndex = 0;
                    console.log(`=== ƒê√É CH·ªåN API HO·∫†T ƒê·ªòNG: #${this.workingApis[0].index} ===`);
                    this.isInitialized = true;
                    return this.workingApis[0];
                } else {
                    console.error("=== KH√îNG C√ì API N√ÄO HO·∫†T ƒê·ªòNG! ===");
                    throw new Error("KH√îNG C√ì API N√ÄO HO·∫†T ƒê·ªòNG!");
                }
            }

            async loadBackupApis() {
                try {
                    console.log("=== ƒêANG T·∫¢I API D·ª∞ PH√íNG ===");
                    
                    // Th·ª≠ c√°c ƒë∆∞·ªùng d·∫´n kh√°c nhau cho file apiphongthu.txt
                    const possiblePaths = [
                        'assets/apiphongthu.txt',
                        './assets/apiphongthu.txt',
                        '/assets/apiphongthu.txt',
                        'apiphongthu.txt',
                        './apiphongthu.txt'
                    ];
                    
                    let response = null;
                    let usedPath = '';
                    
                    // Th·ª≠ t·ª´ng ƒë∆∞·ªùng d·∫´n
                    for (const path of possiblePaths) {
                        try {
                            console.log(`Th·ª≠ ƒë∆∞·ªùng d·∫´n: ${path}`);
                            response = await fetch(path);
                            if (response.ok) {
                                usedPath = path;
                                console.log(`‚úì T√¨m th·∫•y file t·∫°i: ${path}`);
                                break;
                            }
                        } catch (e) {
                            console.log(`‚úó Kh√¥ng t√¨m th·∫•y file t·∫°i: ${path}`);
                            continue;
                        }
                    }
                    
                    if (!response || !response.ok) {
                        console.error("Kh√¥ng th·ªÉ t√¨m th·∫•y file apiphongthu.txt ·ªü b·∫•t k·ª≥ ƒë∆∞·ªùng d·∫´n n√†o");
                        
                        // T·∫°o file m·∫´u ƒë·ªÉ ng∆∞·ªùi d√πng bi·∫øt ƒë·ªãnh d·∫°ng
                        this.createSampleApiFile();
                        return false;
                    }
                    
                    const text = await response.text();
                    console.log("N·ªôi dung file (truncated):", text.substring(0, 200) + "...");
                    
                    // X·ª≠ l√Ω n·ªôi dung file
                    const lines = text.trim().split('\n').filter(line => line.trim() !== '');
                    
                    console.log(`S·ªë d√≤ng trong file: ${lines.length}`);
                    
                    // B·∫Øt ƒë·∫ßu index t·ª´ 1 v√¨ 0 l√† API ch√≠nh
                    let index = 1;
                    
                    // X·ª≠ l√Ω t·ª´ng c·∫∑p key-model
                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        
                        if (!line) continue;
                        
                        // Ki·ªÉm tra n·∫øu d√≤ng n√†y c√≥ v·∫ª l√† API key (c√≥ th·ªÉ ƒë·∫£o ng∆∞·ª£c)
                        if (line.includes('AIza')) {
                            // ƒê√¢y c√≥ th·ªÉ l√† key ƒë√£ ƒë·∫£o ng∆∞·ª£c ho·∫∑c ch∆∞a
                            const reversedKey = line;
                            const model = (i + 1 < lines.length) ? lines[i + 1].trim() : this.primaryModel;
                            
                            console.log(`\n[API #${index}]`);
                            console.log(`Key t·ª´ file: ${reversedKey.substring(0, 20)}...`);
                            
                            // Th·ª≠ ƒë·∫£o ng∆∞·ª£c key ƒë·ªÉ xem c√≥ h·ª£p l·ªá kh√¥ng
                            const normalKey = reverseApiKey(reversedKey);
                            console.log(`Key ƒë·∫£o l·∫°i: ${normalKey.substring(0, 20)}...`);
                            
                            // Ki·ªÉm tra n·∫øu key ƒë·∫£o l·∫°i c√≥ ch·ª©a "AIza" (d·∫•u hi·ªáu c·ªßa key h·ª£p l·ªá)
                            const isValidKey = normalKey.includes("AIza");
                            
                            const apiKey = isValidKey ? normalKey : reversedKey;
                            
                            this.allApis.push({
                                reversedKey: reversedKey,
                                apiKey: apiKey,
                                model: model,
                                isPrimary: false,
                                index: index
                            });
                            
                            console.log(`Model: ${model}`);
                            console.log(`Type: BACKUP`);
                            console.log(`Key h·ª£p l·ªá: ${isValidKey ? '‚úì' : '‚úó'}`);
                            
                            index++;
                            i++; // B·ªè qua d√≤ng model
                        } else if (line.toLowerCase().includes('gemini')) {
                            // ƒê√¢y c√≥ th·ªÉ l√† d√≤ng model
                            // X·ª≠ l√Ω ·ªü l·∫ßn l·∫∑p tr∆∞·ªõc
                            continue;
                        } else {
                            // Th·ª≠ xem c√≥ ph·∫£i l√† key ƒë·∫£o ng∆∞·ª£c kh√¥ng
                            console.log(`\n[API #${index} - Th·ª≠ x·ª≠ l√Ω]`);
                            console.log(`D√≤ng ${i + 1}: ${line.substring(0, 30)}...`);
                            
                            // ƒê·∫£o ng∆∞·ª£c v√† ki·ªÉm tra
                            const normalKey = reverseApiKey(line);
                            const isValidKey = normalKey.includes("AIza");
                            
                            if (isValidKey) {
                                const model = (i + 1 < lines.length) ? lines[i + 1].trim() : this.primaryModel;
                                
                                this.allApis.push({
                                    reversedKey: line,
                                    apiKey: normalKey,
                                    model: model,
                                    isPrimary: false,
                                    index: index
                                });
                                
                                console.log(`‚úì Ph√°t hi·ªán key ƒë·∫£o ng∆∞·ª£c`);
                                console.log(`Model: ${model}`);
                                index++;
                                i++;
                            } else {
                                console.log(`‚úó Kh√¥ng ph·∫£i key ƒë·∫£o ng∆∞·ª£c h·ª£p l·ªá`);
                            }
                        }
                    }
                    
                    console.log(`\n=== K·∫æT QU·∫¢ T·∫¢I API D·ª∞ PH√íNG ===`);
                    console.log(`ƒê√£ t·∫£i ${this.allApis.length - 1} API d·ª± ph√≤ng t·ª´ file`);
                    console.log(`File path: ${usedPath}`);
                    
                    // N·∫øu kh√¥ng c√≥ API d·ª± ph√≤ng, th√™m m·ªôt v√†i API m·∫´u
                    if (this.allApis.length <= 1) {
                        console.log("Kh√¥ng c√≥ API d·ª± ph√≤ng n√†o, th√™m API m·∫´u...");
                        this.addSampleBackupApis();
                    }
                    
                    return true;
                } catch (error) {
                    console.error('L·ªói khi t·∫£i API d·ª± ph√≤ng:', error);
                    
                    // Th√™m API m·∫´u n·∫øu c√≥ l·ªói
                    this.addSampleBackupApis();
                    
                    return false;
                }
            }

            createSampleApiFile() {
                console.log("\n=== T·∫†O FILE M·∫™U apiphongthu.txt ===");
                console.log("Vui l√≤ng t·∫°o file 'apiphongthu.txt' trong th∆∞ m·ª•c 'assets' v·ªõi ƒë·ªãnh d·∫°ng:");
                console.log("M·ªói API g·ªìm 2 d√≤ng:");
                console.log("1. API Key (c√≥ th·ªÉ ƒë·ªÉ ƒë·∫£o ng∆∞·ª£c ho·∫∑c kh√¥ng)");
                console.log("2. Model name (v√≠ d·ª•: gemini-2.5-flash)");
                console.log("\nV√≠ d·ª•:");
                console.log("AIzaSyB... (key ƒë·∫£o ng∆∞·ª£c)");
                console.log("gemini-2.5-flash");
                console.log("\nL∆∞u √Ω: Key ƒë·∫£o ng∆∞·ª£c s·∫Ω an to√†n h∆°n!");
            }

            addSampleBackupApis() {
                console.log("\n=== TH√äM API D·ª∞ PH√íNG M·∫™U ===");
                
                // Th√™m m·ªôt v√†i API m·∫´u (c·∫ßn thay th·∫ø b·∫±ng key th·∫≠t c·ªßa b·∫°n)
                const sampleApis = [
                    {
                        reversedKey: "AIzaSyB... (key m·∫´u 1)",
                        apiKey: "AIzaSyB... (key m·∫´u 1)",
                        model: "gemini-2.5-flash",
                        index: this.allApis.length
                    },
                    {
                        reversedKey: "AIzaSyC... (key m·∫´u 2)",
                        apiKey: "AIzaSyC... (key m·∫´u 2)",
                        model: "gemini-2.5-flash",
                        index: this.allApis.length + 1
                    }
                ];
                
                sampleApis.forEach(api => {
                    this.allApis.push({
                        ...api,
                        isPrimary: false
                    });
                });
                
                console.log(`ƒê√£ th√™m ${sampleApis.length} API m·∫´u`);
            }

            async testApiConnection(apiInfo) {
                try {
                    console.log(`\n[TEST API #${apiInfo.index}]`);
                    console.log(`Key ƒë·∫£o ng∆∞·ª£c (trong file): ${apiInfo.reversedKey.substring(0, 20)}...`);
                    console.log(`Key ƒë√£ ƒë·∫£o l·∫°i (ƒë·ªÉ d√πng): ${apiInfo.apiKey.substring(0, 20)}...`);
                    console.log(`Model: ${apiInfo.model}`);
                    console.log(`Type: ${apiInfo.isPrimary ? 'PRIMARY' : 'BACKUP'}`);
                    
                    // Ki·ªÉm tra xem key c√≥ h·ª£p l·ªá kh√¥ng
                    if (!apiInfo.apiKey || apiInfo.apiKey.length < 20) {
                        console.log(`[API #${apiInfo.index}] ‚úó KEY KH√îNG H·ª¢P L·ªÜ (qu√° ng·∫Øn)`);
                        return null;
                    }
                    
                    // Ki·ªÉm tra xem key c√≥ ch·ª©a AIza kh√¥ng
                    if (!apiInfo.apiKey.includes("AIza")) {
                        console.log(`[API #${apiInfo.index}] ‚úó KEY KH√îNG H·ª¢P L·ªÜ (thi·∫øu 'AIza')`);
                        return null;
                    }
                    
                    const genAI = new GoogleGenerativeAI(apiInfo.apiKey);
                    const testModel = genAI.getGenerativeModel({ model: apiInfo.model });
                    
                    // Test v·ªõi c√¢u h·ªèi ƒë∆°n gi·∫£n (timeout 10s)
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000);
                    
                    try {
                        const testResult = await testModel.generateContent("Xin ch√†o");
                        const response = await testResult.response;
                        const text = response.text();
                        
                        clearTimeout(timeoutId);
                        
                        console.log(`[API #${apiInfo.index}] ‚úì HO·∫†T ƒê·ªòNG T·ªêT`);
                        console.log(`    Ph·∫£n h·ªìi: ${text.substring(0, 50)}...`);
                        
                        return {
                            ...apiInfo,
                            status: 'working',
                            testResponse: text.substring(0, 100)
                        };
                    } catch (timeoutError) {
                        console.log(`[API #${apiInfo.index}] ‚úó TIMEOUT`);
                        return null;
                    }
                } catch (error) {
                    console.log(`[API #${apiInfo.index}] ‚úó L·ªñI: ${error.message}`);
                    return null;
                }
            }

            async testAllApisSequentially() {
                this.workingApis = [];
                
                console.log(`\n=== B·∫ÆT ƒê·∫¶U KI·ªÇM TRA ${this.allApis.length} API ===`);
                
                // Test tu·∫ßn t·ª± t·ª´ng API
                for (let i = 0; i < this.allApis.length; i++) {
                    const apiInfo = this.allApis[i];
                    const result = await this.testApiConnection(apiInfo);
                    
                    if (result) {
                        this.workingApis.push(result);
                    }
                    
                    // Delay nh·∫π gi·ªØa c√°c l·∫ßn test
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                console.log(`\n=== K·∫æT QU·∫¢ KI·ªÇM TRA ===`);
                console.log(`‚úì API ho·∫°t ƒë·ªông: ${this.workingApis.length}/${this.allApis.length}`);
                
                if (this.workingApis.length === 0) {
                    console.log("\n‚ö†Ô∏è C·∫¢NH B√ÅO: Kh√¥ng c√≥ API n√†o ho·∫°t ƒë·ªông!");
                    console.log("Vui l√≤ng ki·ªÉm tra:");
                    console.log("1. File apiphongthu.txt c√≥ t·ªìn t·∫°i kh√¥ng?");
                    console.log("2. API key c√≥ h·ª£p l·ªá kh√¥ng?");
                    console.log("3. B·∫°n c√≥ k·∫øt n·ªëi internet kh√¥ng?");
                }
                
                // Log chi ti·∫øt t·ª´ng API
                console.log("\n=== CHI TI·∫æT T·ª™NG API ===");
                this.allApis.forEach(api => {
                    const isWorking = this.workingApis.some(w => w.index === api.index);
                    const status = isWorking ? '‚úì' : '‚úó';
                    console.log(`[${api.index}] ${status} ${api.isPrimary ? 'PRIMARY' : 'BACKUP'}`);
                    console.log(`     Key: ${api.reversedKey.substring(0, 25)}...`);
                    console.log(`     Model: ${api.model}`);
                });
            }

            getCurrentApi() {
                if (this.workingApis.length === 0) return null;
                return this.workingApis[this.currentApiIndex];
            }

            async switchToNextApi() {
                if (this.workingApis.length <= 1) {
                    console.log("Kh√¥ng c√≤n API d·ª± ph√≤ng n√†o!");
                    return false;
                }
                
                // T√¨m API ho·∫°t ƒë·ªông ti·∫øp theo
                const nextIndex = (this.currentApiIndex + 1) % this.workingApis.length;
                this.currentApiIndex = nextIndex;
                
                console.log(`ƒê√£ chuy·ªÉn sang API #${this.workingApis[nextIndex].index}`);
                return this.workingApis[nextIndex];
            }

            async tryAllApisForResponse(userMessage, conversationHistory) {
                console.log("\n=== TH·ª¨ T·∫§T C·∫¢ API ƒê·ªÇ TR·∫¢ L·ªúI ===");
                
                // N·∫øu kh√¥ng c√≥ API n√†o ho·∫°t ƒë·ªông
                if (this.workingApis.length === 0) {
                    console.log("Kh√¥ng c√≥ API n√†o ho·∫°t ƒë·ªông!");
                    return {
                        success: false,
                        error: "Kh√¥ng c√≥ API n√†o ho·∫°t ƒë·ªông"
                    };
                }
                
                for (let i = 0; i < this.workingApis.length; i++) {
                    const apiIndex = (this.currentApiIndex + i) % this.workingApis.length;
                    const apiInfo = this.workingApis[apiIndex];
                    
                    console.log(`Th·ª≠ API #${apiInfo.index}...`);
                    
                    try {
                        const genAI = new GoogleGenerativeAI(apiInfo.apiKey);
                        const model = genAI.getGenerativeModel({ model: apiInfo.model });
                        
                        const chatSession = model.startChat({
                            history: conversationHistory,
                            generationConfig: {
                                maxOutputTokens: 2000,
                                temperature: 0.9,
                                topP: 0.1,
                                topK: 16,
                            }
                        });

                        const result = await chatSession.sendMessage(userMessage);
                        const response = await result.response;
                        const botReply = response.text();
                        
                        // C·∫≠p nh·∫≠t API hi·ªán t·∫°i n·∫øu th√†nh c√¥ng
                        this.currentApiIndex = apiIndex;
                        console.log(`‚úì Th√†nh c√¥ng v·ªõi API #${apiInfo.index}`);
                        
                        return {
                            success: true,
                            response: botReply,
                            apiInfo: apiInfo
                        };
                    } catch (error) {
                        console.log(`‚úó API #${apiInfo.index} l·ªói: ${error.message}`);
                        
                        // ƒê√°nh d·∫•u API n√†y kh√¥ng ho·∫°t ƒë·ªông
                        this.workingApis = this.workingApis.filter(api => api.index !== apiInfo.index);
                        console.log(`ƒê√£ lo·∫°i b·ªè API #${apiInfo.index} kh·ªèi danh s√°ch ho·∫°t ƒë·ªông`);
                        
                        continue;
                    }
                }
                
                console.log("‚úó T·∫•t c·∫£ API ƒë·ªÅu l·ªói!");
                return {
                    success: false,
                    error: "T·∫•t c·∫£ API ƒë·ªÅu kh√¥ng ho·∫°t ƒë·ªông"
                };
            }
        }

        class SimpleGeminiChatbot {
            constructor() {
                this.apiDefense = new APIDefenseSystem();
                this.conversationHistory = [];
                this.isSending = false;
                this.typingInterval = null;
                this.genAI = null;
                this.model = null;
                this.currentApiInfo = null;
            }

            async initialize() {
                console.log("=== KH·ªûI T·∫†O CHATBOT API PH√íNG TH·ª¶ ===");
                
                // Hi·ªÉn th·ªã th√¥ng b√°o ƒëang kh·ªüi t·∫°o
                this.addMessageToUI("assistant", 
                    "**üîß ƒêang kh·ªüi t·∫°o h·ªá th·ªëng API Ph√≤ng Th·ªß...**\n\n" +
                    "1. ƒêang t·∫£i API key ch√≠nh...\n" +
                    "2. ƒêang t·∫£i API d·ª± ph√≤ng...\n" +
                    "3. ƒêang ki·ªÉm tra k·∫øt n·ªëi...\n\n" +
                    "Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t..."
                );
                
                try {
                    const apiInfo = await this.apiDefense.initialize();
                    this.currentApiInfo = apiInfo;
                    this.genAI = new GoogleGenerativeAI(apiInfo.apiKey);
                    this.model = this.genAI.getGenerativeModel({ model: apiInfo.model });
                    
                    console.log(`=== CHATBOT ƒê√É S·∫¥N S√ÄNG ===`);
                    console.log(`ƒêang d√πng API: #${apiInfo.index}`);
                    console.log(`Model: ${apiInfo.model}`);
                    console.log(`T·ªïng API ho·∫°t ƒë·ªông: ${this.apiDefense.workingApis.length}/${this.apiDefense.allApis.length}`);
                    
                    // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
                    const chatMessages = document.getElementById('chat-messages');
                    if (chatMessages) {
                        chatMessages.innerHTML = '';
                        this.addMessageToUI("assistant", 
                            `‚úÖ **H·ªá th·ªëng API Ph√≤ng Th·ªß ƒë√£ s·∫µn s√†ng!**\n\n` +
                            `‚Ä¢ **API ƒëang d√πng:** #${apiInfo.index}\n` +
                            `‚Ä¢ **Model:** ${apiInfo.model}\n` +
                            `‚Ä¢ **API ho·∫°t ƒë·ªông:** ${this.apiDefense.workingApis.length}/${this.apiDefense.allApis.length}\n\n` +
                            `H·ªá th·ªëng t·ª± ƒë·ªông chuy·ªÉn API n·∫øu c√≥ l·ªói. B·∫°n c√≥ th·ªÉ b·∫Øt ƒë·∫ßu chat ngay!`
                        );
                        
                        // Hi·ªÉn th·ªã c·∫£nh b√°o n·∫øu ch·ªâ c√≥ 1 API
                        if (this.apiDefense.workingApis.length <= 1) {
                            this.addMessageToUI("assistant",
                                `‚ö†Ô∏è **C·∫¢NH B√ÅO:** Ch·ªâ c√≥ 1 API ho·∫°t ƒë·ªông!\n` +
                                `Vui l√≤ng th√™m nhi·ªÅu API d·ª± ph√≤ng v√†o file **apiphongthu.txt** ƒë·ªÉ ƒë·∫£m b·∫£o h·ªá th·ªëng ·ªïn ƒë·ªãnh.`
                            );
                        }
                    }
                    
                    // C·∫≠p nh·∫≠t tr·∫°ng th√°i v√† b·∫≠t input
                    this.updateStatus();
                    this.enableInput();
                    
                } catch (error) {
                    console.error("L·ªói kh·ªüi t·∫°o:", error);
                    
                    const chatMessages = document.getElementById('chat-messages');
                    if (chatMessages) {
                        chatMessages.innerHTML = '';
                        this.addMessageToUI("assistant", 
                            `‚ùå **L·ªñI KH·ªûI T·∫†O H·ªÜ TH·ªêNG**\n\n` +
                            `Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi b·∫•t k·ª≥ API n√†o.\n\n` +
                            `**Kh·∫Øc ph·ª•c:**\n` +
                            `1. T·∫°o file **apiphongthu.txt** trong th∆∞ m·ª•c **assets**\n` +
                            `2. Th√™m API key d·ª± ph√≤ng (m·ªói API g·ªìm 2 d√≤ng: key v√† model)\n` +
                            `3. Refresh trang ƒë·ªÉ th·ª≠ l·∫°i\n\n` +
                            `V√≠ d·ª• n·ªôi dung file:\n` +
                            `\`\`\`\n` +
                            `AIzaSyB...your_api_key_here\n` +
                            `gemini-2.5-flash\n` +
                            `\`\`\``
                        );
                    }
                    
                    this.updateStatus(false);
                }
            }

            updateStatus(success = true) {
                const statusElement = document.getElementById('current-api-status');
                if (statusElement) {
                    if (success && this.currentApiInfo) {
                        statusElement.className = 'api-status status-active';
                        statusElement.innerHTML = `<i class="fas fa-check-circle mr-1"></i> API #${this.currentApiInfo.index} (${this.apiDefense.workingApis.length}/${this.apiDefense.allApis.length} ho·∫°t ƒë·ªông)`;
                    } else {
                        statusElement.className = 'api-status status-error';
                        statusElement.innerHTML = `<i class="fas fa-exclamation-circle mr-1"></i> Kh√¥ng c√≥ API ho·∫°t ƒë·ªông`;
                    }
                }
            }

            enableInput() {
                const messageInput = document.getElementById('message-input');
                if (messageInput) {
                    messageInput.disabled = false;
                    messageInput.placeholder = "Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n... (Enter ƒë·ªÉ g·ª≠i, Shift+Enter ƒë·ªÉ xu·ªëng d√≤ng)";
                    messageInput.focus();
                }
            }

            setupUI() {
                this.chatContainer = document.getElementById('chat-container');
                this.chatMessages = document.getElementById('chat-messages');
                this.chatForm = document.getElementById('chat-form');
                this.messageInput = document.getElementById('message-input');
                this.typingIndicator = document.getElementById('typing-indicator');

                this.setupEventListeners();
                this.setupTextareaAutoResize();
            }

            setupEventListeners() {
                this.chatForm.addEventListener('submit', (e) => this.handleSubmit(e));
                
                this.messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        if (this.messageInput.value.trim() !== '') {
                            this.chatForm.dispatchEvent(new Event('submit'));
                        }
                    }
                });
            }

            setupTextareaAutoResize() {
                this.messageInput.addEventListener('input', () => {
                    this.messageInput.style.height = 'auto';
                    const newHeight = Math.min(this.messageInput.scrollHeight, 150);
                    this.messageInput.style.height = `${newHeight}px`;
                });
            }

            async handleSubmit(e) {
                e.preventDefault();
                const userMessage = this.messageInput.value.trim();
                if (!userMessage || this.isSending) return;

                this.isSending = true;
                this.addMessageToUI("user", userMessage);
                
                this.messageInput.value = "";
                this.messageInput.style.height = 'auto';
                
                this.typingIndicator.classList.remove("hidden");

                try {
                    // Th·ª≠ t·∫•t c·∫£ API ƒë·ªÉ tr·∫£ l·ªùi
                    const result = await this.apiDefense.tryAllApisForResponse(
                        userMessage, 
                        this.conversationHistory.map(msg => ({
                            role: msg.role === "user" ? "user" : "model",
                            parts: [{ text: msg.content }]
                        }))
                    );

                    if (result.success) {
                        // C·∫≠p nh·∫≠t API hi·ªán t·∫°i
                        this.currentApiInfo = result.apiInfo;
                        this.genAI = new GoogleGenerativeAI(result.apiInfo.apiKey);
                        this.model = this.genAI.getGenerativeModel({ model: result.apiInfo.model });
                        
                        // Hi·ªÉn th·ªã c√¢u tr·∫£ l·ªùi v·ªõi hi·ªáu ·ª©ng g√µ ch·ªØ
                        this.displayTypingMessage(result.response);
                        
                        // L∆∞u v√†o l·ªãch s·ª≠ h·ªôi tho·∫°i
                        this.conversationHistory.push({ 
                            role: "user", 
                            content: userMessage,
                            timestamp: new Date().toISOString()
                        });
                        
                        this.conversationHistory.push({ 
                            role: "assistant", 
                            content: result.response,
                            timestamp: new Date().toISOString()
                        });
                        
                        // C·∫≠p nh·∫≠t tr·∫°ng th√°i
                        this.updateStatus();
                        
                        console.log(`ƒê√£ tr·∫£ l·ªùi th√†nh c√¥ng v·ªõi API #${result.apiInfo.index}`);
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error("L·ªói khi g·ª≠i tin nh·∫Øn:", error);
                    this.addMessageToUI("assistant", 
                        `‚ùå **ƒê√£ h·∫øt API d·ª± ph√≤ng**\n\n` +
                        `T·∫•t c·∫£ API ƒë·ªÅu b·ªã l·ªói:\n` +
                        `${error.message}\n\n` +
                        `**Vui l√≤ng:**\n` +
                        `1. Refresh trang ƒë·ªÉ th·ª≠ l·∫°i\n` +
                        `2. Ki·ªÉm tra file apiphongthu.txt\n` +
                        `3. Th√™m API key m·ªõi`
                    );
                    this.updateStatus(false);
                } finally {
                    this.isSending = false;
                    this.typingIndicator.classList.add("hidden");
                    this.scrollToBottom();
                }
            }

            displayTypingMessage(content) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'bot-message';
                messageDiv.innerHTML = '<div class="message-content"></div>';
                this.chatMessages.appendChild(messageDiv);
                this.scrollToBottom();

                let i = 0;
                const speed = 10;
                const contentDiv = messageDiv.querySelector('.message-content');

                if (this.typingInterval) clearInterval(this.typingInterval);
                
                this.typingInterval = setInterval(() => {
                    if (i < content.length) {
                        contentDiv.innerHTML = this.formatMessage(content.substring(0, i + 1));
                        i++;
                        this.scrollToBottom();
                    } else {
                        clearInterval(this.typingInterval);
                        this.typingInterval = null;
                    }
                }, speed);
            }

            addMessageToUI(role, content) {
                const messageDiv = document.createElement('div');
                messageDiv.className = role === 'user' ? 'user-message' : 'bot-message';
                
                const formattedContent = this.formatMessage(content);
                messageDiv.innerHTML = `<div class="message-content">${formattedContent}</div>`;
                
                this.chatMessages.appendChild(messageDiv);
                this.scrollToBottom();
            }

            formatMessage(content) {
                if (!content) return '';

                let formatted = content
                    .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*([^*]+)\*/g, '<em>$1</em>')
                    .replace(/`([^`]+)`/g, '<code class="bg-gray-800 px-1 py-0.5 rounded">$1</code>');

                // X·ª≠ l√Ω code block
                formatted = formatted.replace(/```([\s\S]*?)```/g, '<pre class="bg-gray-800 p-3 rounded-lg overflow-x-auto"><code>$1</code></pre>');

                formatted = formatted.split('\n\n').map(paragraph => {
                    return `<p>${paragraph}</p>`;
                }).join('');

                formatted = formatted.replace(/\n(?![<])/g, '<br>');

                return formatted;
            }

            scrollToBottom() {
                setTimeout(() => {
                    this.chatContainer.scrollTop = this.chatContainer.scrollHeight;
                }, 100);
            }
        }

        // Kh·ªüi t·∫°o chatbot
        document.addEventListener('DOMContentLoaded', async () => {
            const chatbot = new SimpleGeminiChatbot();
            window.chatbot = chatbot;
            
            // Setup UI tr∆∞·ªõc
            chatbot.setupUI();
            
            // Kh·ªüi t·∫°o h·ªá th·ªëng
            chatbot.initialize().then(() => {
                console.log("Chatbot ƒë√£ s·∫µn s√†ng!");
            }).catch(error => {
                console.error("L·ªói kh·ªüi t·∫°o chatbot:", error);
            });
        });
    </script>
</body>
</html>